<project name="metawidget-gwt-addressbook" default="create-project">

	<property environment="env" />
	<property name="addressbook.gwt.project.dir" value="/gwt-addressbook-project" />

	<!-- Check for GWT_HOME -->

	<condition property="gwt.home" value="${env.GWT_HOME}">
		<isset property="env.GWT_HOME" />
	</condition>

	<!-- Check for METAWIDGET_HOME -->

	<condition property="metawidget.home" value="${env.METAWIDGET_HOME}">
		<isset property="env.METAWIDGET_HOME" />
	</condition>

	<available property="metawidget-exists" file="${metawidget.home}/metawidget.jar"/>
	<available property="metawidget-gwt-client-exists" file="${metawidget.home}/examples/gwt/metawidget-gwt-client.jar"/>

	<target name="check">
		<fail message="Cannot find GWT_HOME. Please define the GWT_HOME environment variable or use: ant -Dgwt.home=&lt;gwt home dir> &lt;target>" unless="gwt.home" />
		<fail message="Cannot find METAWIDGET_HOME. Please define the METAWIDGET_HOME environment variable or use: ant -Dmetawidget.home=&lt;metawidget home dir> &lt;target>" unless="metawidget.home" />
		<fail message="Cannot find metawidget.jar at ${metawidget.home}. Is that the location of the binary distribution?" unless="metawidget-exists" />
		<fail message="Cannot find /examples/gwt/metawidget-gwt-client.jar at ${metawidget.home}. Is that the location of the binary distribution?" unless="metawidget-gwt-client-exists" />
		<echo message="Building using gwt.home = ${gwt.home}, metawidget.home = ${metawidget.home}" />
		<echo message="Writing output to addressbook.gwt.project.dir = ${addressbook.gwt.project.dir}" />
	</target>

	<!-- Clean -->
		
	<target name="clean">
		<delete dir="${addressbook.gwt.project.dir}" />
	</target>

	<!-- Create Project -->
	
	<target name="create-project" depends="clean, check">

		<exec executable="${gwt.home}/projectCreator.cmd" failonerror="true">
			<arg line="-eclipse AddressBook -out ${addressbook.gwt.project.dir}" />
		</exec>

		<exec executable="${gwt.home}/applicationCreator.cmd" failonerror="true">
			<arg line="-eclipse AddressBook org.metawidget.example.gwt.addressbook.client.AddressBook -out ${addressbook.gwt.project.dir}" />
		</exec>

		<delete dir="${addressbook.gwt.project.dir}/src/org/metawidget/example"/>
		
		<copy todir="${addressbook.gwt.project.dir}/src/org/metawidget/example">
			<fileset dir="../../java/org/metawidget/example" includes="gwt/**,shared/**,GwtAddressBook.gwt.xml" />
		</copy>

		<copy todir="${addressbook.gwt.project.dir}/src">
			<fileset dir="addressbook/WEB-INF" includes="inspector-config.xml, metawidget-metadata.xml" />
		</copy>

		<copy todir="${addressbook.gwt.project.dir}/test">
			<fileset dir="../../../../test/src/java" includes="org/metawidget/test/example/gwt/addressbook/**" />
		</copy>

		<mkdir dir="${addressbook.gwt.project.dir}/lib" />
		<copy todir="${addressbook.gwt.project.dir}/lib">
			<fileset dir="../../../../lib" includes="ejb3-persistence.jar,hibernate-validator.jar,javax.servlet.jsp.jar">
			</fileset>
			<fileset dir="${metawidget.home}" includes="metawidget.jar" />
			<fileset dir="${metawidget.home}/examples/gwt" includes="metawidget-gwt-client.jar" />
		</copy>

		<!-- Launch configuration -->
		
		<replace file="${addressbook.gwt.project.dir}/Addressbook.launch" token="org.metawidget.example.gwt.addressbook.AddressBook" value="org.metawidget.example.GwtAddressBook" />
		<replace file="${addressbook.gwt.project.dir}/.classpath" token="&lt;/classpath>" value='&lt;classpathentry kind="lib" path="lib/metawidget.jar"/>
			&lt;classpathentry kind="lib" path="lib/metawidget-gwt-client.jar"/>
			&lt;classpathentry kind="lib" path="lib/ejb3-persistence.jar"/>
			&lt;classpathentry kind="lib" path="lib/hibernate-validator.jar"/>
			&lt;classpathentry kind="lib" path="lib/javax.servlet.jsp.jar"/>
			&lt;/classpath>' />
		
		<!-- Test launch configuration -->

		<copy file="${addressbook.gwt.project.dir}/Addressbook.launch" tofile="${addressbook.gwt.project.dir}/AddressbookTest.launch" />
		<replace file="${addressbook.gwt.project.dir}/AddressbookTest.launch" token="org.eclipse.jdt.launching.localJavaApplication" value="org.eclipse.jdt.junit.launchconfig" />
		<replace file="${addressbook.gwt.project.dir}/AddressbookTest.launch" token="com.google.gwt.dev.GWTShell" value="org.metawidget.test.example.gwt.addressbook.client.GwtAddressBookTest" />
		<replace file="${addressbook.gwt.project.dir}/AddressbookTest.launch">
				<replacetoken><![CDATA[</listAttribute>]]></replacetoken>
				<replacevalue><![CDATA[<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#13;&#10;&lt;runtimeClasspathEntry internalArchive=&quot;/AddressBook/test&quot; path=&quot;3&quot; type=&quot;2&quot;/&gt;&#13;&#10;"/></listAttribute>]]></replacevalue>
		</replace>
		
	</target>

</project>
