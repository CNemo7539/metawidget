<project name="metawidget-gwt-hosted" default="create-projects">

	<property environment="env" />
	<property name="gwt.project.dir" value="/metawidget-gwt-hosted" />
	<property name="addressbook.dir" value="addressbook" />
	<property name="clientside.dir" value="clientside" />

	<!-- Check for GWT_HOME -->

	<condition property="gwt.home" value="${env.GWT_HOME}">
		<isset property="env.GWT_HOME" />
	</condition>

	<!-- Check for METAWIDGET_HOME -->

	<condition property="metawidget.home" value="${env.METAWIDGET_HOME}">
		<isset property="env.METAWIDGET_HOME" />
	</condition>

	<available property="metawidget-exists" file="${metawidget.home}/metawidget.jar"/>
	<available property="metawidget-gwt-client-exists" file="${metawidget.home}/examples/gwt/metawidget-gwt-client.jar"/>

	<target name="check">
		<fail message="Cannot find GWT_HOME. It must point to the binary GWT distribution. Please define the GWT_HOME environment variable or use: ant -Dgwt.home=&lt;gwt home dir> &lt;target>" unless="gwt.home" />
		<fail message="Cannot find METAWIDGET_HOME. It must point to the binary Metawidget distribution. Please define the METAWIDGET_HOME environment variable or use: ant -Dmetawidget.home=&lt;metawidget home dir> &lt;target>" unless="metawidget.home" />
		<fail message="Cannot find metawidget.jar at ${metawidget.home}. Is that the location of the binary distribution?" unless="metawidget-exists" />
		<fail message="Cannot find /examples/gwt/metawidget-gwt-client.jar at ${metawidget.home}. Is that the location of the binary distribution?" unless="metawidget-gwt-client-exists" />
		<echo message="Building using gwt.home = ${gwt.home}, metawidget.home = ${metawidget.home}" />
	</target>

	<!-- Clean -->
		
	<target name="clean">
		<delete dir="${gwt.project.dir}" />
	</target>

	<!-- Create Projects -->
	
	<target name="create-projects" depends="clean, check">
		
		<antcall target="create-project-addressbook"/>
		<antcall target="create-project-clientside"/>
		
	</target>

	<!-- Create Project -->
	
	<target name="create-project-addressbook">

		<echo message="Writing output to gwt.project.dir/addressbook.dir = ${gwt.project.dir}/${addressbook.dir}" />

		<!-- Standard GWT create -->
		
		<exec executable="${gwt.home}/webAppCreator.cmd" failonerror="true">
			<arg line="-out ${gwt.project.dir}/${addressbook.dir} org.metawidget.example.gwt.addressbook.client.AddressBook" />
		</exec>

		<!-- Update src files -->

		<delete dir="${gwt.project.dir}/${addressbook.dir}/src/org/metawidget/example"/>
		
		<copy todir="${gwt.project.dir}/${addressbook.dir}/src/org/metawidget/example">
			<fileset dir="../../java/org/metawidget/example" includes="gwt/addressbook/**,shared/addressbook/**,GwtAddressBook.gwt.xml" />
		</copy>

		<!-- Update web files -->

		<delete dir="${gwt.project.dir}/${addressbook.dir}/war"/>
		<copy todir="${gwt.project.dir}/${addressbook.dir}/war">
			<fileset dir="addressbook">
				<exclude name="index*.jsp"/>
			</fileset>
		</copy>
		<copy todir="${gwt.project.dir}/${addressbook.dir}/war" failonerror="false">
			<fileset dir="../shared" >
				<exclude name="**/*.tag"/>
			</fileset>
		</copy>
		<copy tofile="${gwt.project.dir}/${addressbook.dir}/war/index.jsp" file="addressbook/index-hosted.jsp"/>

		<copy todir="${gwt.project.dir}/${addressbook.dir}/war/WEB-INF/lib">
			<fileset dir="../../../../lib" includes="ejb3-persistence.jar,hibernate-validator.jar"/>
			<fileset dir="${metawidget.home}" includes="metawidget.jar" />
		</copy>
		
		<!-- Update lib JARs -->
		
		<mkdir dir="${gwt.project.dir}/${addressbook.dir}/lib" />
		<copy todir="${gwt.project.dir}/${addressbook.dir}/lib">
			<fileset dir="${metawidget.home}/examples/gwt" includes="metawidget-gwt-client.jar" />
		</copy>

		<!-- Update test files -->
		
		<copy todir="${gwt.project.dir}/${addressbook.dir}/test">
			<fileset dir="../../../../test/src/java" includes="org/metawidget/test/example/gwt/addressbook/**" />
		</copy>

		<!-- Classpath -->
			
		<replace file="${gwt.project.dir}/${addressbook.dir}/.classpath" token='&lt;classpathentry kind="src" path="src"/>' value='&lt;classpathentry kind="src" path="src"/>&lt;classpathentry kind="src" path="test"/>'/>
		<replace file="${gwt.project.dir}/${addressbook.dir}/.classpath" token="&lt;/classpath>" value='&lt;classpathentry kind="lib" path="war/WEB-INF/lib/ejb3-persistence.jar"/>
			&lt;classpathentry kind="lib" path="war/WEB-INF/lib/hibernate-validator.jar"/>
			&lt;classpathentry kind="lib" path="war/WEB-INF/lib/metawidget.jar"/>
			&lt;classpathentry kind="lib" path="lib/metawidget-gwt-client.jar"/>
			&lt;/classpath>' />
		
		<!-- Launch configuration -->
		
		<replace file="${gwt.project.dir}/${addressbook.dir}/Addressbook.launch" token="org.metawidget.example.gwt.addressbook.client.AddressBook" value="org.metawidget.example.GwtAddressBook" />
		<replace file="${gwt.project.dir}/${addressbook.dir}/Addressbook.launch" token="AddressBook.html" value="index.jsp" />
		
		<!-- Test launch configuration -->

		<copy file="${gwt.project.dir}/${addressbook.dir}/Addressbook.launch" tofile="${gwt.project.dir}/${addressbook.dir}/AddressbookTest.launch" />
		<replace file="${gwt.project.dir}/${addressbook.dir}/AddressbookTest.launch" token="org.eclipse.jdt.launching.localJavaApplication" value="org.eclipse.jdt.junit.launchconfig" />
		<replace file="${gwt.project.dir}/${addressbook.dir}/AddressbookTest.launch" token="com.google.gwt.dev.HostedMode" value="org.metawidget.test.example.gwt.addressbook.client.GwtAddressBookTest" />
		<replace file="${gwt.project.dir}/${addressbook.dir}/AddressbookTest.launch">
				<replacetoken><![CDATA[</listAttribute>]]></replacetoken>
				<replacevalue><![CDATA[<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#13;&#10;&lt;runtimeClasspathEntry internalArchive=&quot;/AddressBook/test&quot; path=&quot;3&quot; type=&quot;2&quot;/&gt;&#13;&#10;"/><listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#13;&#10;&lt;runtimeClasspathEntry internalArchive=&quot;/AddressBook/war/WEB-INF&quot; path=&quot;3&quot; type=&quot;2&quot;/&gt;&#13;&#10;"/></listAttribute>]]></replacevalue>
		</replace>
		
	</target>

	<target name="create-project-clientside">

		<echo message="Writing output to gwt.project.dir/clientside.dir = ${gwt.project.dir}/${clientside.dir}" />
		
		<!-- Standard GWT create -->
		
		<exec executable="${gwt.home}/webAppCreator.cmd" failonerror="true">
			<arg line="-out ${gwt.project.dir}/${clientside.dir} org.metawidget.example.gwt.clientside.client.ClientSide" />
		</exec>

		<!-- Update src files -->

		<delete dir="${gwt.project.dir}/${clientside.dir}/src/org/metawidget/example"/>
		
		<copy todir="${gwt.project.dir}/${clientside.dir}/src/org/metawidget/example/gwt/clientside">
			<fileset dir="../../java/org/metawidget/example/gwt/clientside" />
		</copy>

		<!-- Update web files -->

		<delete dir="${gwt.project.dir}/${clientside.dir}/war"/>
		<copy todir="${gwt.project.dir}/${clientside.dir}/war">
			<fileset dir="clientside"/>
		</copy>

		<!-- Update lib JARs -->
		
		<mkdir dir="${gwt.project.dir}/${clientside.dir}/lib" />		
		<copy todir="${gwt.project.dir}/${clientside.dir}/lib">
			<fileset dir="${metawidget.home}/examples/gwt" includes="metawidget-gwt-client.jar" />
			<fileset dir="${metawidget.home}" includes="metawidget.jar" />
		</copy>

		<!-- Update test files -->
		
		<copy todir="${gwt.project.dir}/${clientside.dir}/test">
			<fileset dir="../../../../test/src/java" includes="org/metawidget/test/example/gwt/clientside/**" />
		</copy>

		<!-- Classpath -->
			
		<replace file="${gwt.project.dir}/${clientside.dir}/.classpath" token='&lt;classpathentry kind="src" path="src"/>' value='&lt;classpathentry kind="src" path="src"/>&lt;classpathentry kind="src" path="test"/>'/>
		<replace file="${gwt.project.dir}/${clientside.dir}/.classpath" token="&lt;/classpath>" value='&lt;classpathentry kind="lib" path="lib/metawidget.jar"/>
			&lt;classpathentry kind="lib" path="lib/metawidget-gwt-client.jar"/>
			&lt;/classpath>' />
		
		<!-- Launch configuration -->
		
		<replace file="${gwt.project.dir}/${clientside.dir}/ClientSide.launch" token="org.metawidget.example.gwt.clientside.client.ClientSide" value="org.metawidget.example.gwt.clientside.GwtClientSide" />
		<replace file="${gwt.project.dir}/${clientside.dir}/ClientSide.launch" token="ClientSide.html" value="index.html" />
		
		<!-- Test launch configuration -->

		<copy file="${gwt.project.dir}/${clientside.dir}/ClientSide.launch" tofile="${gwt.project.dir}/${clientside.dir}/ClientSideTest.launch" />
		<replace file="${gwt.project.dir}/${clientside.dir}/ClientSideTest.launch" token="org.eclipse.jdt.launching.localJavaApplication" value="org.eclipse.jdt.junit.launchconfig" />
		<replace file="${gwt.project.dir}/${clientside.dir}/ClientSideTest.launch" token="com.google.gwt.dev.HostedMode" value="org.metawidget.test.example.gwt.clientside.client.GwtClientSideTest" />
		<replace file="${gwt.project.dir}/${clientside.dir}/ClientSideTest.launch">
				<replacetoken><![CDATA[</listAttribute>]]></replacetoken>
				<replacevalue><![CDATA[<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#13;&#10;&lt;runtimeClasspathEntry internalArchive=&quot;/ClientSide/test&quot; path=&quot;3&quot; type=&quot;2&quot;/&gt;&#13;&#10;"/><listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#13;&#10;&lt;runtimeClasspathEntry internalArchive=&quot;/ClientSide/war/WEB-INF&quot; path=&quot;3&quot; type=&quot;2&quot;/&gt;&#13;&#10;"/></listAttribute>]]></replacevalue>
		</replace>
		
	</target>

</project>
