<project name="metawidget-website" default="website">

	<!-- Properties -->
	
	<property file="build.properties"/>
	<property file="${relative.dir}/test/build.properties"/>
	<import file="${relative.dir}/test/build.xml" />
	<property file="${relative.dir}/src/doc/build.properties"/>
	<import file="${relative.dir}/src/doc/build.xml" />

	<!-- Dist -->

	<target name="dist" depends="clean, test-init, pack, doc, examples">

		<!-- Source -->
		
		<mkdir dir="${relative.dir}/${build.dir}/${metawidget.name}"/>

		<copy todir="${relative.dir}/${build.dir}/${metawidget.name}">
			<fileset dir="${relative.dir}">				
				<exclude name="**/.*/**"/>
				<exclude name="bin/**"/>
				<exclude name="build/**"/>
				<exclude name="**/WEB-INF/classes/**"/>
				<exclude name="**/Thumbs.db"/>
				<exclude name="**/junit*.properties"/>
			</fileset>
		</copy>
	
		<zip zipfile="${relative.dir}/${build.dir}/${metawidget.name}-src.zip">
			<fileset dir="${relative.dir}/${build.dir}">				
				<include name="${metawidget.name}/**"/>
			</fileset>				
		</zip>
		
		<!-- Binaries -->
			
		<antcall target="pack-debug"/>
		<copy todir="${relative.dir}/${build.dir}/${metawidget.name}">
			<fileset dir="${relative.dir}/${build.dir}">
				<include name="debug/**"/>
			</fileset>
		</copy>

		<copy todir="${relative.dir}/${build.dir}/${metawidget.name}">
			<fileset dir="${relative.dir}/${build.dir}">
				<include name="debug/**"/>
				<include name="doc/api/**"/>
				<include name="doc/coverage/**"/>
				<include name="doc/taglib/**"/>
				<include name="doc/reference/**/html*/*.html"/>
				<include name="doc/reference/**/pdf/*.pdf"/>
				<include name="doc/**/shared/**"/>
				<include name="examples/**"/>
				<include name="metawidget.jar"/>
			</fileset>
		</copy>

		<zip zipfile="${relative.dir}/${build.dir}/${metawidget.name}.zip">
			<fileset dir="${relative.dir}/${build.dir}">
				<include name="${metawidget.name}/**"/>
				<exclude name="${metawidget.name}/**/build.xml"/>
				<exclude name="${metawidget.name}/**/build.properties"/>
				<exclude name="${metawidget.name}/**/lib/**"/>
				<exclude name="${metawidget.name}/examples/src/**"/>
				<exclude name="${metawidget.name}/src/**"/>
				<exclude name="${metawidget.name}/test/**"/>
			</fileset>
			<fileset dir="${relative.dir}/${build.dir}">
				<include name="${metawidget.name}/examples/faces/**/build.xml"/>
				<include name="${metawidget.name}/examples/faces/**/build.properties"/>				
				<include name="${metawidget.name}/examples/faces/**/lib/**"/>
				<include name="${metawidget.name}/examples/swing/lib/**"/>
				<include name="${metawidget.name}/examples/swt/lib/**"/>
			</fileset>
		</zip>

	</target>

	<target name="live-demo" depends="pack,compile-examples">
		
		<delete failonerror="false">
			<fileset dir="${tomcat.dir}/webapps/ROOT/live-demo">
				<include name="*.jar"/>
				<include name="*.jar.pack"/>
			</fileset>			
		</delete>
		<mkdir dir="${tomcat.dir}/webapps/ROOT/live-demo"/>
		<mkdir dir="${relative.dir}/${build.dir}/website"/>
		
		<jar destfile="${relative.dir}/${build.dir}/website/console-applet.jar">
			<fileset dir="${relative.dir}/${build.dir}/example-classes">
				<include name="org/metawidget/example/swing/console/**"/>
			</fileset>
		</jar>
		
		<taskdef name="pack200" classname="com.sun.tools.apache.ant.pack200.Pack200Task" classpath="${relative.dir}/examples/lib/Pack200Task.jar"/>
		<pack200 repack="true" src="${relative.dir}/${build.dir}/website/console-applet.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar"/>		
		<pack200 repack="true" src="${relative.dir}/${build.dir}/metawidget.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar"/>		
		<copy todir="${tomcat.dir}/webapps/ROOT/live-demo">
			<fileset dir="${relative.dir}/lib">
				<include name="ejb3-persistence.jar"/>
				<include name="groovy*.jar"/>
				<include name="hibernate-validator.jar"/>
			</fileset>
		</copy>		

		<signjar alias="Metawidget" keystore="${relative.dir}/examples/src/java/org/metawidget/example/swing/console/metawidget.keystore" storepass="m3t4w1dg3t">
			<path>
				<fileset dir="${tomcat.dir}/webapps/ROOT/live-demo">
					<include name="console-applet.jar*"/>
					<include name="metawidget.jar*"/>
					<include name="groovy*.jar*"/>
				</fileset>				
			</path>
		</signjar>

		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/ejb3-persistence.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/ejb3-persistence.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/hibernate-validator.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/hibernate-validator.jar.pack"/>		

	</target>
	
	<target name="m2repo" depends="pack">
		
		<copy todir="${tomcat.dir}/webapps/ROOT">
			<fileset dir="${relative.dir}/src/web/site">
				<include name="m2repo/**"/>
			</fileset>
		</copy>

		<!-- JARs -->
			
		<copy file="${relative.dir}/${build.dir}/metawidget.jar" tofile="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}.jar"/>
		
		<jar destfile="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}-sources.jar">
			<fileset dir="${relative.dir}/src/java"/>
		</jar>
		
		<!-- Checksums -->
	
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/maven-metadata.xml"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/maven-metadata.xml" algorithm="SHA1"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}.jar"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}.jar" algorithm="SHA1"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}.pom"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}.pom" algorithm="SHA1"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}-sources.jar"/>
		<checksum file="${tomcat.dir}/webapps/ROOT/m2repo/${metawidget.version}/metawidget-${metawidget.version}-sources.jar" algorithm="SHA1"/>
		
	</target>

	<target name="xsd" depends="pack">
				
		<taskdef name="xmlSchemaGenerator" classname="org.metawidget.config.XmlSchemaGeneratorTask">
			<classpath>
				<pathelement path="${relative.dir}/${build.dir}/classes"/>
				<fileset dir="${relative.dir}/lib"/>
				<fileset dir="${relative.dir}/test/lib">
					<include name="emma.jar"/>
				</fileset>
			</classpath>
		</taskdef>
		
		<xmlSchemaGenerator jar="${relative.dir}/${build.dir}/metawidget.jar" destdir="${relative.dir}/${build.dir}/xsd"/>
	
	</target>	

	<target name="website" depends="test-init">

		<delete dir="${tomcat.dir}/webapps"/>

		<!-- XSDs (do these first, because otherwise we seemed to crash on the SWT ones) -->
		
		<antcall target="xsd"/>

		<!-- JSP version -->

		<copy todir="${relative.dir}/${build.dir}/lib" flatten="true" includeemptydirs="false">
			<fileset dir="${relative.dir}/lib"/>
			<fileset dir="${relative.dir}/examples/src/web">
				<include name="**/lib/**"/>
			</fileset>
		</copy>

		<copy todir="${tomcat.dir}/webapps/ROOT">
			<fileset dir="${relative.dir}/src/web/site"/>
		</copy>
			
		<copy todir="${tomcat.dir}/webapps/ROOT/WEB-INF/lib">
			<fileset dir="${relative.dir}/${build.dir}/lib">
				<include name="jstl-*.jar"/>
				<include name="standard.jar"/>
			</fileset>
		</copy>

		<!-- Extract HTML -->

		<available property="httrack-exists" file="${httrack.dir}/httrack.exe"/>
		<fail message="HTTrack not installed at 'httrack.dir' (as indicated in build.properties)" unless="httrack-exists"/>

		<antcall target="test-web-start-tomcat"/>
		<sleep seconds="30"/>
		<delete dir="${relative.dir}/${build.dir}/website"/>
		
		<exec executable="${httrack.dir}/httrack.exe" failonerror="false" failifexecutionfails="false" >
			<arg value="${webtest.url}"/>
			<arg value="--path"/>
			<arg value="${relative.dir}/${build.dir}/website"/>
			<arg value="--keep-links=4"/>
			<arg value="--footer"/>
			<arg value="&quot;&quot;"/>
		</exec>

		<antcall target="test-web-stop-tomcat"/>
		<delete dir="${tomcat.dir}/webapps"/>		

		<move todir="${tomcat.dir}/webapps/ROOT">
			<fileset dir="${relative.dir}/${build.dir}/website/localhost_8080"/>
		</move>

		<copy file="${relative.dir}/src/java/org/metawidget/config/metawidget-1.0.xsd" todir="${tomcat.dir}/webapps/ROOT/xsd"/>
		<copy file="${relative.dir}/src/java/org/metawidget/inspector/inspection-result-1.0.xsd" todir="${tomcat.dir}/webapps/ROOT/xsd"/>
		<move todir="${tomcat.dir}/webapps/ROOT/xsd">
			<fileset dir="${relative.dir}/${build.dir}/xsd"/>
		</move>
		
		<!-- Little cleanup -->
		
		<delete file="${tomcat.dir}/webapps/ROOT/index-2.html"/>
		<delete file="${tomcat.dir}/webapps/ROOT/xsd.html"/>
		<delete file="${tomcat.dir}/webapps/ROOT/xsd/inspection-result-1.0.html"/>
		<delete file="${tomcat.dir}/webapps/ROOT/xsd/metawidget-1.0.html"/>
		<delete file="${tomcat.dir}/webapps/ROOT/live-demo/index-2.html"/>
		<delete dir="${tomcat.dir}/webapps/ROOT/live-demo/org"/>
			
		<!-- Doco -->

		<antcall target="docbook"/>
		<antcall target="javadoc"/>
		<antcall target="tlddoc"/>

		<copy todir="${tomcat.dir}/webapps/ROOT" overwrite="true">			
			<fileset dir="${relative.dir}/${build.dir}">
				<include name="doc/api/**"/>
				<include name="doc/coverage/**"/>
				<include name="doc/taglib/**"/>
				<include name="doc/reference/**/html*/*.html"/>
				<include name="doc/reference/**/pdf/*.pdf"/>
				<include name="doc/**/shared/**"/>
			</fileset>
		</copy>

		<!-- Try to have something at TLD URIs -->

		<copy file="${relative.dir}/src/java/META-INF/metawidget-faces.tld" tofile="${tomcat.dir}/webapps/ROOT/faces/index.html"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-faces.tld" todir="${tomcat.dir}/webapps/ROOT/faces"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-html.tld" tofile="${tomcat.dir}/webapps/ROOT/html/index.html"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-html.tld" todir="${tomcat.dir}/webapps/ROOT/html"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-spring.tld" tofile="${tomcat.dir}/webapps/ROOT/spring/index.html"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-spring.tld" todir="${tomcat.dir}/webapps/ROOT/spring"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-struts.tld" tofile="${tomcat.dir}/webapps/ROOT/struts/index.html"/>
		<copy file="${relative.dir}/src/java/META-INF/metawidget-struts.tld" todir="${tomcat.dir}/webapps/ROOT/struts"/>

		<!-- (SourceForge runs on UNIX, and we want to keep file sizes the same for easy diffs) -->

		<fixcrlf srcdir="${tomcat.dir}/webapps/ROOT" eol="unix">
			<include name="**/*.css"/>
			<include name="**/*.html"/>
			<include name="**/*.js"/>
		</fixcrlf>
		
		<!-- JavaScript images tend to get missed by httrack -->
			
		<copy todir="${tomcat.dir}/webapps/ROOT/media">
			<fileset dir="${relative.dir}/src/web/site/media"/>
		</copy>

		<!-- Live demo -->

		<antcall target="live-demo"/>
		
		<!-- m2repo -->
		
		<antcall target="m2repo"/>
		
		<!-- Test console applet -->

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="${relative.dir}/${build.dir}/${run.dir}">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file '${relative.dir}/test/src/web/examples/swing/console-test.xml'"/>
		</java>

		<!-- Test HTML links

		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="${relative.dir}/test/src/web/site">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file test.xml"/>
		</java>
		
		<antcall target="test-web-stop-tomcat"/> -->

	</target>
	
</project>
