<project name="metawidget" default="dist">

	<!-- Properties -->
		
	<property file="build.properties"/>
	<property name="metawidget.name" value="${ant.project.name}-${metawidget.version}"/>
	<property name="run.dir" value="${build.dir}/run"/>	
	
	<!-- Clean -->

	<target name="clean">		
		<delete dir="${build.dir}"/>
	</target>
	
	<!-- Init -->

	<target name="init">
		<mkdir dir="${build.dir}"/>
		<mkdir dir="${run.dir}"/>
		<mkdir dir="${run.dir}/logs"/>
	</target>

	<!-- Compile -->

	<target name="compile-main" depends="init" unless="skip-compile-main">
		
		<mkdir dir="${build.dir}/java5-classes"/>
		<mkdir dir="${build.dir}/java4-classes"/>
		<mkdir dir="${build.dir}/classes"/>

		<echo message="Note: Metawidget requires Java SE 6 to build, though only J2SE 1.4 to run"/>
		<echo message="      This is because some optional features require Java SE 6"/>
		<echo message="      (eg. annotations, javax.swing.GroupLayout)"/>

		<!-- As a first step, build everything as Java SE 5 -->

		<javac srcdir="src/java" destdir="${build.dir}/java5-classes" debug="${build.debug}" optimize="on" target="1.5">
			<classpath>
				<fileset dir="lib"/>
			</classpath>
		</javac>

		<!-- Now downgrade some files to J2SE 1.4 (the source is still Java 5, to take advantage -->
		<!-- of cleaner source code, but we compile down to jsr14. We can do this using plain    -->
		<!-- javac, without needing retroweaver or similar tools)                                -->

		<javac sourcepath="" srcdir="src/java" destdir="${build.dir}/java4-classes" debug="${build.debug}" optimize="on" source="1.5" target="jsr14">
			<include name="**/*InspectionResultConstants.java"/>
			<include name="org/metawidget/faces/**"/>
			<include name="org/metawidget/gwt/**"/>
			<include name="org/metawidget/inspector/*.java"/>
			<include name="org/metawidget/inspector/composite/**"/>
			<include name="org/metawidget/inspector/gwt/**"/>
			<include name="org/metawidget/inspector/hibernate/*.java"/>
			<include name="org/metawidget/inspector/iface/**"/>
			<include name="org/metawidget/inspector/impl/*.java"/>
			<include name="org/metawidget/inspector/impl/actionstyle/*.java"/>
			<include name="org/metawidget/inspector/impl/propertystyle/**"/>
			<include name="org/metawidget/inspector/jbpm/**"/>
			<include name="org/metawidget/inspector/propertytype/**"/>
			<include name="org/metawidget/inspector/struts/**"/>
			<exclude name="org/metawidget/inspector/struts/StrutsAnnotationInspector.java"/>
			<exclude name="org/metawidget/inspector/struts/UiStrutsLookup.java"/>
			<include name="org/metawidget/inspector/xml/**"/>
			<include name="org/metawidget/jsp/**"/>
			<include name="org/metawidget/mixin/**"/>
			<include name="org/metawidget/spring/**"/>
			<include name="org/metawidget/struts/**"/>
			<include name="org/metawidget/swing/**"/>
			<include name="org/metawidget/util/**"/>
			<include name="org/metawidget/*.java"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/java5-classes"/>
			</classpath>
		</javac>
		
		<!-- Mix the Java SE 5 and J2SE 1.4 files together -->
		
		<copy todir="${build.dir}/classes">
			<fileset dir="${build.dir}/java5-classes"/>
		</copy>

		<copy todir="${build.dir}/classes" overwrite="true">
			<fileset dir="${build.dir}/java4-classes"/>
		</copy>
	
	</target>
		
	<target name="compile-examples" depends="compile-main" unless="skip-compile-examples">

		<mkdir dir="${build.dir}/example-classes"/>
		<mkdir dir="${build.dir}/scala-example-classes"/>

		<javac sourcepath="" srcdir="examples/src/java" destdir="${build.dir}/example-classes" debug="${build.debug}" optimize="on" target="1.5">
			<include name="org/metawidget/example/android/**"/>
			<include name="org/metawidget/example/swing/appframework/**"/>
			<include name="org/metawidget/example/swing/applet/**"/>
			<include name="org/metawidget/example/swing/console/**"/>
			<include name="org/metawidget/example/**/addressbook/**"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>
			</classpath>
		</javac>

		<!-- Build Scala files -->

		<taskdef resource="scala/tools/ant/antlib.xml">
			<classpath>
				<fileset dir="lib">
					<include name="scala-*.jar"/>
				</fileset>
			</classpath>
		</taskdef>

		<scalac srcdir="examples/src/scala" destdir="${build.dir}/scala-example-classes">
			<include name="**/*.scala"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>
				<fileset dir="examples/src/scala/org/metawidget/example/swing/animalraces"/>
			</classpath>
		</scalac>

		<property name="skip-compile-examples" value="true"/>

	</target>

	<target name="compile-test" depends="compile-examples" unless="skip-compile-test">

		<mkdir dir="${build.dir}/test-classes"/>
		<mkdir dir="${build.dir}/groovy-test-classes"/>
		<mkdir dir="${build.dir}/scala-test-classes"/>
		<mkdir dir="${build.dir}/tutorial-classes"/>

		<javac sourcepath="" srcdir="test/src/java" destdir="${build.dir}/test-classes" debug="on" optimize="on" source="1.5" target="jsr14">
			<include name="org/metawidget/test/faces/allwidgets/**"/>
			<include name="org/metawidget/test/faces/richfaces/allwidgets/**"/>
			<include name="org/metawidget/test/shared/allwidgets/**"/>
			<include name="org/metawidget/test/spring/allwidgets/**"/>
			<include name="org/metawidget/test/struts/allwidgets/**"/>
			<include name="org/metawidget/test/swing/allwidgets/**"/>
			<include name="org/metawidget/test/swing/SwingAllWidgetsTest.java"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>
			</classpath>
		</javac>
		
		<!-- Build tutorial files (which are neither 'src/test' files, nor should -->
		<!-- end up as examples in the finished distribution                      -->
		
		<javac sourcepath="" srcdir="examples/src/java" destdir="${build.dir}/tutorial-classes" debug="on" optimize="on" target="1.5">
			<include name="org/metawidget/example/**/tutorial/**"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>
			</classpath>
		</javac>

		<!-- Build Groovy files -->

		<taskdef name="groovyc" classname="org.codehaus.groovy.ant.Groovyc">
			<classpath>
				<fileset dir="lib"/>
			</classpath>
		</taskdef>

		<groovyc srcdir="test/src/groovy" destdir="${build.dir}/groovy-test-classes">
			<include name="**/*.groovy"/>
			<classpath>
				<fileset dir="lib"/>
			</classpath>
		</groovyc>

		<!-- Build Scala files -->

		<taskdef resource="scala/tools/ant/antlib.xml">
			<classpath>
				<fileset dir="lib">
					<include name="scala-*.jar"/>
				</fileset>
			</classpath>
		</taskdef>

		<scalac srcdir="test/src/scala" destdir="${build.dir}/scala-test-classes">
			<include name="**/*.scala"/>
			<classpath>
				<fileset dir="lib"/>
			</classpath>
		</scalac>

		<!-- Build test files -->

		<javac sourcepath="" srcdir="test/src/java" destdir="${build.dir}/test-classes" debug="off" target="1.5">
			<include name="org/metawidget/test/inspector/impl/propertystyle/javassist/JavassistPropertyStyleDebugOffTest.java"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>				
			</classpath>
		</javac>
		
		<javac sourcepath="" srcdir="test/src/java" destdir="${build.dir}/test-classes" debug="on" target="1.5">
			<exclude name="org/metawidget/test/faces/allwidgets/**"/>
			<exclude name="org/metawidget/test/faces/richfaces/allwidgets/**"/>
			<exclude name="org/metawidget/test/inspector/impl/propertystyle/javassist/JavassistPropertyStyleDebugOffTest.java"/>
			<exclude name="org/metawidget/test/shared/allwidgets/**"/>
			<exclude name="org/metawidget/test/spring/allwidgets/**"/>
			<exclude name="org/metawidget/test/struts/allwidgets/**"/>
			<exclude name="org/metawidget/test/swing/allwidgets/**"/>
			<exclude name="org/metawidget/test/swing/SwingAllWidgetsTest.java"/>
			<classpath>
				<fileset dir="lib"/>
				<pathelement path="${build.dir}/classes"/>				
				<pathelement path="${build.dir}/example-classes"/>				
				<pathelement path="${build.dir}/tutorial-classes"/>				
				<pathelement path="${build.dir}/groovy-test-classes"/>				
				<pathelement path="${build.dir}/scala-test-classes"/>				
				<pathelement path="${build.dir}/scala-example-classes"/>
			</classpath>
		</javac>
		
		<property name="skip-compile-test" value="true"/>

	</target>

	<!-- Pack -->

	<target name="pack" depends="pack-internal">

		<move file="${build.dir}/pack/metawidget.jar" tofile="${build.dir}/metawidget.jar" />
		
	</target>

	<target name="pack-debug">

		<delete failonerror="false">
			<fileset dir="${build.dir}">
				<include name="classes/**"/>
				<include name="java4-classes/**"/>
				<include name="java5-classes/**"/>
			</fileset>
		</delete>

		<property name="build.debug" value="on"/>

		<antcall target="pack-internal"/>

		<mkdir dir="${build.dir}/debug"/>		
		<move file="${build.dir}/pack/metawidget.jar" tofile="${build.dir}/debug/metawidget-debug-version.jar" />
		<copy file="src/debug/readme.txt" tofile="${build.dir}/debug/readme.txt"/>
		
	</target>

	<target name="pack-as-frontend-backend">

		<antcall target="pack-as-frontend-backend-internal"/>
		<move file="${build.dir}/pack/metawidget-frontend.jar" tofile="${build.dir}/metawidget-frontend.jar" />
		<move file="${build.dir}/pack/metawidget-backend.jar" tofile="${build.dir}/metawidget-backend.jar" />

	</target>
	
	<target name="pack-as-frontend-backend-debug">

		<delete failonerror="false">
			<fileset dir="${build.dir}">
				<include name="classes/**"/>
				<include name="java4-classes/**"/>
				<include name="java5-classes/**"/>
			</fileset>
		</delete>

		<property name="build.debug" value="on"/>
		<antcall target="pack-as-frontend-backend-internal"/>

		<mkdir dir="${build.dir}/debug"/>		
		<move file="${build.dir}/pack/metawidget-frontend.jar" tofile="${build.dir}/debug/metawidget-frontend-debug-version.jar" />
		<move file="${build.dir}/pack/metawidget-backend.jar" tofile="${build.dir}/debug/metawidget-backend-debug-version.jar" />
		
	</target>

	<target name="pack-internal" depends="compile-main">
		
		<mkdir dir="${build.dir}/pack"/>		
		<jar destfile="${build.dir}/pack/metawidget.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/classes">
				<include name="org/**"/>
				<exclude name="org/metawidget/gwt/**"/>
				<exclude name="org/metawidget/example/**"/>
				<exclude name="org/metawidget/inspector/gwt/remote/client/**"/>
				<exclude name="org/metawidget/test/**"/>
			</fileset>
			<fileset dir="src/java">
				<exclude name="META-INF/metawidget.bnd"/>
				<exclude name="org/metawidget/example/**"/>
				<include name="org/metawidget/swing/icon/**"/>
				<include name="**/faces-config.xml"/>
				<include name="**/*.xsd"/>
				<include name="**/*.taglib.xml"/>
				<include name="**/*.tld"/>
			</fileset>
		</jar>
		
		<!-- OSGI headers -->

		<taskdef resource="aQute/bnd/ant/taskdef.properties">
			<classpath>
				<fileset dir="lib">
					<include name="bnd-*.jar"/>
				</fileset>
			</classpath>
		</taskdef>
		<bndwrap jars="${build.dir}/pack/metawidget.jar" output="${build.dir}/pack/metawidget.jar" definitions="src/java/META-INF" />
		
	</target>

	<target name="pack-as-frontend-backend-internal" depends="compile-main">

		<mkdir dir="${build.dir}/pack"/>		
		<jar destfile="${build.dir}/pack/metawidget-backend.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/inspector/**/Ui*.class"/>
				<include name="org/metawidget/inspector/**/*Constants.class"/>
			</fileset>
		</jar>
		
		<jar destfile="${build.dir}/pack/metawidget-frontend.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/classes">
				<include name="org/**"/>
				<exclude name="org/metawidget/gwt/**"/>
				<exclude name="org/metawidget/inspector/gwt/remote/client/**"/>
				<exclude name="org/metawidget/inspector/**/Ui*.class"/>
				<exclude name="org/metawidget/inspector/**/*Constants.class"/>
				<exclude name="org/metawidget/example/**"/>
				<exclude name="org/metawidget/test/**"/>
			</fileset>
			<fileset dir="src/java">
				<include name="META-INF/*"/>
				<include name="org/metawidget/swing/icon/**"/>
				<include name="org/metawidget/inspector/*.xsd"/>				
			</fileset>
		</jar>

	</target>

	<target name="pack-gwt-client">

		<jar destfile="${build.dir}/metawidget-gwt-client.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="src/java">
				<include name="org/metawidget/gwt/**"/>
				<include name="org/metawidget/inspector/iface/**"/>
				<include name="org/metawidget/inspector/gwt/remote/iface/**"/>
				<include name="org/metawidget/inspector/gwt/remote/client/**"/>
				<include name="org/metawidget/mixin/base/**"/>
				<include name="org/metawidget/mixin/gwt/**"/>
				<include name="org/metawidget/util/simple/**"/>
				<include name="org/metawidget/GwtMetawidget.gwt.xml"/>
				<exclude name="**/package-info.java"/>
			</fileset>
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/gwt/**"/>
				<include name="org/metawidget/inspector/iface/**"/>
				<include name="org/metawidget/inspector/gwt/remote/iface/**"/>
				<include name="org/metawidget/inspector/gwt/remote/client/**"/>
				<include name="org/metawidget/mixin/base/**"/>
				<include name="org/metawidget/mixin/gwt/**"/>
				<include name="org/metawidget/util/simple/**"/>
			</fileset>
		</jar>
		
	</target>

	<target name="pack-util-debug">
		
		<delete failonerror="false">
			<fileset dir="${build.dir}">
				<include name="classes/**"/>
				<include name="java4-classes/**"/>
				<include name="java5-classes/**"/>
			</fileset>
		</delete>

		<property name="build.debug" value="on"/>
		<antcall target="pack-util-internal"/>
		
	</target>

	<target name="pack-util-internal" depends="compile-main">
		
		<mkdir dir="${build.dir}/debug"/>		
		<jar destfile="${build.dir}/debug/metawidget-util-debug-version.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/util/**"/>
			</fileset>
		</jar>
		
	</target>

	<target name="flatten-libs" depends="pack,compile-examples">
		
		<copy todir="${build.dir}/lib" flatten="true" includeemptydirs="false">
			<fileset dir="lib"/>
			<fileset dir="examples/src/web">
				<include name="**/lib/**"/>
			</fileset>
			<fileset dir="test/src/web">
				<include name="**/lib/**"/>
			</fileset>
		</copy>

		<delete dir="${build.dir}/lib/lib" quiet="true"/>
				
		<copy todir="${build.dir}/lib" file="${build.dir}/metawidget.jar"/>
	</target>
				
	<!-- API Documentation -->
	
	<available property="ydoc-available" file="${ydoc.dir}/lib/ydoc.jar"/>
	
	<target name="javadoc-ydoc" depends="compile-main" if="ydoc-available">

		<javadoc destdir="${build.dir}/doc/api"
			author="true" version="true" use="true"
			protected="true"
			windowtitle="Metawidget API Documentation"
			overview="src/doc/api/overview.html">
			
			<arg value="-notimestamp"/>

			<packageset dir="src/java">
				<include name="org/metawidget/**"/>
				<exclude name="org/metawidget/example/**"/>
			</packageset>

			<classpath>
				<fileset dir="lib">
					<include name="*.jar"/>
				</fileset>
			</classpath>
	
			<doclet name="ydoc.doclets.YStandard"
					path="${ydoc.dir}/lib/ydoc.jar:${ydoc.dir}/resources:${ydoc.dir}/lib/class2svg.jar:${build.dir}/classes">
					<param name="-umlautogen"/>
					<param name="-umlstyle" value="theBlues"/>
			</doclet>
	
		</javadoc>
		
	</target>
	
	<target name="javadoc-plain" depends="compile-main" unless="ydoc-available">
		
		<echo level="warning" message="YDoc not installed at 'ydoc.dir' in 'build.properties'. Building JavaDoc without YDoc"/>
		
		<javadoc destdir="${build.dir}/doc/api"
			author="true" version="true" use="true"
			protected="true"
			windowtitle="Metawidget API Documentation"
			overview="src/doc/api/overview.html">

			<arg value="-notimestamp"/>

			<packageset dir="src/java">
				<include name="org/metawidget/**"/>
				<exclude name="org/metawidget/example/**"/>
			</packageset>

			<classpath>
				<fileset dir="lib">
					<include name="*.jar"/>
				</fileset>
			</classpath>
	
		</javadoc>
		
	</target>

	<target name="javadoc" depends="javadoc-plain, javadoc-ydoc" />

	<target name="tlddoc">

		<java jar="lib/tlddoc.jar" fork="true" failonerror="true">
	        <arg line="-d ${build.dir}/doc/taglib"/>
	        <arg value="src/java/META-INF/*.tld"/>
      	</java>
		
	</target>
	
	<!-- Reference Documentation -->
	
	<available property="docbook-available" file="${docbook.dir}/build-docbook.xml"/>

	<target name="docbook-skip" unless="docbook-available">

		<echo level="warning" message="DocBook not installed at 'docbook.dir' in 'build.properties'. Not building reference documentation"/>

	</target>

	<target name="docbook-ok" if="docbook-available">
		
		<!-- Copy shared CSS -->
		
		<copy todir="${build.dir}/doc/reference/en/shared/css">
			<fileset dir="src/doc/reference/css/html"/>
		</copy>

		<!-- Copy shared images -->
		
		<copy todir="${build.dir}/doc/reference/en/shared">
			<fileset dir="src/doc/reference/en">
				<include name="images/**"/>
			</fileset>
		</copy>

		<!-- DocBook EN -->

		<ant antfile="${docbook.dir}/build-docbook.xml" target="all">
			<property name="dbf.basedir" value="${docbook.dir}"/>
			<property name="src.dir" value="src/doc/reference/en"/>
			<property name="docbook.dir" value="."/>
			<property name="docbook.file" value="metawidget"/>
			<property name="images.src.dir" value="src/doc/reference/en/images"/>
			<property name="css.src.dir" value="src/doc/reference/css"/>
			<property name="styles.src.dir" value="src/doc/reference/styles"/>
			<property name="target.dir" value="${build.dir}/doc/reference/en"/>
		</ant>
		
		<!-- Copy docbook images -->
		
		<copy todir="${build.dir}/doc/reference/en/shared">
			<fileset dir="${build.dir}/doc/reference/en/html">
				<include name="images/*.gif"/>
			</fileset>
		</copy>

	</target>

	<target name="docbook" depends="docbook-ok, docbook-skip" />
	
	<!-- Unit Tests -->
	
	<target name="test-unit-desktop" depends="examples-desktop,compile-test">

		<!-- Note: run the unit tests against the actual metawiget.jar and   -->
		<!--       addressbook-swing.jar, to make sure they packed correctly -->

		<!-- Note: network access is disabled for Unit Tests, to make sure Metawidget isn't trying external DTDs -->

		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Djava.util.logging.config.file=${basedir}/test/src/java/logging.properties"/>
			<jvmarg value="-Dhttp.proxyHost=prevent.all.network.access"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.AllTests"/>
			<classpath>
				<fileset dir="lib">
					<exclude name="android.jar"/>
				</fileset>
				<pathelement location="${build.dir}/metawidget.jar"/>
				<pathelement location="${build.dir}/examples/swing/addressbook-swing.jar"/>
				<pathelement location="${build.dir}/examples/swing/animalraces-swing.jar"/>
				<pathelement location="${build.dir}/examples/swing/appframework-swing.jar"/>
				<pathelement path="${build.dir}/test-classes"/>
				<pathelement path="${build.dir}/groovy-test-classes"/>
				<pathelement path="${build.dir}/scala-test-classes"/>
				<pathelement path="${build.dir}/tutorial-classes"/>
				<pathelement path="examples/src/java"/>
				<pathelement path="test/src/java"/>
			</classpath>
		</junit>
		
		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Djava.util.logging.config.file=${basedir}/test/src/java/logging.properties"/>
			<jvmarg value="-Dhttp.proxyHost=prevent.all.network.access"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.util.LogUtilsTest"/>
			<classpath>
				<fileset dir="lib">
					<include name="emma.jar"/>
					<include name="junit-*.jar"/>
				</fileset>
				<pathelement location="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/test-classes"/>
			</classpath>
		</junit>
	
	</target>

	<target name="test-unit-gwt" depends="example-gwt-addressbook,compile-test">
		
		<copy todir="${build.dir}/gwt-example-src">
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/gwt/addressbook/public/**"/>
			</fileset>			
			<fileset dir="test/src/java">
				<include name="org/metawidget/test/*.gwt.xml"/>
				<include name="org/metawidget/test/gwt/allwidgets/*.gwt.xml"/>
				<include name="org/metawidget/test/gwt/allwidgets/**/*.java"/>
				<include name="org/metawidget/test/example/gwt/addressbook/**"/>
				<include name="org/metawidget/test/shared/allwidgets/model/*.java"/>
			</fileset>			
		</copy>
		
		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Xmx256M"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.example.gwt.addressbook.client.GwtAddressBookTest"/>
			<classpath>				
				<pathelement path="examples/src/web/gwt/addressbook/WEB-INF"/>
				<pathelement path="examples/src/web/gwt/addressbook/WEB-INF/config"/>
				<dirset dir="${build.dir}/gwt-example-src"/>
				<dirset dir="${build.dir}/example-classes"/>
				<dirset dir="${build.dir}/test-classes"/>
				<fileset dir="lib">
					<exclude name="android.jar"/>
				</fileset>
				<pathelement path="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/examples/gwt/metawidget-gwt-client.jar"/>
			</classpath>
		</junit>
		
		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Xmx256M"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.gwt.allwidgets.client.GwtAllWidgetsTest"/>
			<classpath>
				<pathelement path="test/src/java/org/metawidget/test/gwt/allwidgets"/>
				<pathelement path="test/src/java"/>
				<dirset dir="${build.dir}/gwt-example-src"/>
				<dirset dir="${build.dir}/test-classes"/>
				<fileset dir="lib">
					<exclude name="android.jar"/>
				</fileset>
				<pathelement path="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/examples/gwt/metawidget-gwt-client.jar"/>
			</classpath>
		</junit>

		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Xmx256M"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.gwt.quirks.client.GwtQuirksTest"/>
			<classpath>
				<pathelement path="test/src/java/org/metawidget/test/gwt/quirks"/>
				<pathelement path="test/src/java"/>
				<dirset dir="${build.dir}/test-classes"/>
				<fileset dir="lib">
					<exclude name="android.jar"/>
				</fileset>
				<pathelement path="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/examples/gwt/metawidget-gwt-client.jar"/>
			</classpath>
		</junit>

		<junit showoutput="true" fork="true" dir="${run.dir}" haltonfailure="true" haltonerror="true">
			<jvmarg value="-Xmx256M"/>
			<formatter type="brief" usefile="false"/>
			<test name="org.metawidget.test.gwt.client.ui.GwtMetawidgetMixinTest"/>
			<classpath>
				<pathelement path="test/src/java"/>
				<dirset dir="${build.dir}/test-classes"/>
				<fileset dir="lib">
					<exclude name="android.jar"/>
				</fileset>
				<pathelement path="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/examples/gwt/metawidget-gwt-client.jar"/>
			</classpath>
		</junit>
	
	</target>

	<target name="test-unit-14" depends="compile-test">

		<available property="java4-exists" file="${java4.dir}/bin"/>
		<fail message="JDK 1.4 not installed at 'java4.dir' (as indicated in build.properties)" unless="java4-exists"/>

		<java classname="junit.textui.TestRunner" fork="true" jvm="${java4.dir}/bin/java" dir="${run.dir}">
			<arg line="org.metawidget.test.swing.SwingAllWidgetsTest"/>
			<classpath>
				<fileset dir="lib">
					<exclude name="android.jar"/>
					<exclude name="junit*.jar"/>
				</fileset>
				<pathelement location="test/lib-1.4/junit.jar"/>
				<pathelement location="${build.dir}/metawidget.jar"/>
				<pathelement path="${build.dir}/test-classes"/>
				<pathelement path="test/src/java"/>
			</classpath>
		</java>

	</target>

	<target name="test-unit" depends="test-unit-desktop, test-unit-gwt, test-unit-14"/>

	<target name="test-coverage" depends="clean">

		<!-- Compile with debug on -->
		
		<property name="build.debug" value="on"/>		
		<antcall target="compile-test"/>
		<property name="skip-compile-main" value="true"/>		

		<!-- Instrument -->

		<path id="emma.lib" >
			<pathelement location="lib/emma.jar" />
			<pathelement location="lib/emma_ant.jar" />
		</path>
		
		<taskdef resource="emma_ant.properties" classpathref="emma.lib" />
		
		<emma>
			<instr instrpath="${build.dir}/classes" destdir="${build.dir}/classes" metadatafile="${run.dir}/metadata.emma" merge="true" mode="overwrite">
				<filter excludes="*Constants, org.metawidget.android.*, org.metawidget.example.android.*, org.metawidget.gwt.client.*, org.metawidget.inspector.gwt.remote.client.*"/>				
			</instr>
			<instr instrpath="${build.dir}/example-classes" destdir="${build.dir}/example-classes" metadatafile="${run.dir}/metadata.emma" merge="true" mode="overwrite">
				<filter excludes="org.metawidget.example.android.*, org.metawidget.example.gwt.addressbook.client.*, org.metawidget.example.gwt.addressbook.inspector.remote.client.*, org.metawidget.example.swing.console.*"/>				
			</instr>
			<instr instrpath="${build.dir}/tutorial-classes" destdir="${build.dir}/tutorial-classes" metadatafile="${run.dir}/metadata.emma" merge="true" mode="overwrite">
				<filter excludes="org.metawidget.example.swing.tutorial.Main"/>
			</instr>
		</emma>

		<!-- Prep servers -->
		
		<available property="tomcat-exists" file="${tomcat.dir}/bin/bootstrap.jar"/>
		<fail message="Apache Tomcat not installed at 'tomcat.dir' (as indicated in build.properties)" unless="tomcat-exists"/>
		<copy todir="${tomcat.dir}/lib" file="lib/emma.jar"/>

		<available property="tomcat4-exists" file="${tomcat4.dir}/bin/bootstrap.jar"/>
		<fail message="Apache Tomcat 4 not installed at 'tomcat4.dir' (as indicated in build.properties)" unless="tomcat4-exists"/>
		<copy todir="${tomcat4.dir}/shared/lib" file="lib/emma.jar"/>

		<available property="jboss-exists" file="${jboss.dir}/bin/run.bat"/>
		<fail message="JBoss not installed at 'jboss.dir' (as indicated in build.properties)" unless="jboss-exists"/>
		<copy todir="${jboss.dir}/server/default/lib" file="lib/emma.jar"/>

		<available property="glassfish-exists" file="${glassfish.dir}/bin/asadmin.bat"/>
		<fail message="GlassFish not installed at 'glassfish.dir' (as indicated in build.properties)" unless="glassfish-exists"/>
		<copy todir="${glassfish.dir}/domains/${glassfish.domain}/lib" file="lib/emma.jar"/>

		<available property="jetty-exists" file="${jetty.dir}/start.jar"/>
		<fail message="Jetty not installed at 'jetty.dir' (as indicated in build.properties)" unless="jetty-exists"/>
		<copy todir="${jetty.dir}/lib" file="lib/emma.jar"/>

		<!-- Run tests as normal -->

		<antcall target="test"/>

		<!-- Report -->

		<emma>
			<report>
				<sourcepath>
					<dirset dir="examples/src/java"/>
					<dirset dir="src/java"/>
					<dirset dir="test/src/java"/>
		        </sourcepath>				
				<fileset dir="${run.dir}">
					<include name="*.ec"/>
					<include name="*.emma"/>
				</fileset>
				<html outfile="${build.dir}/doc/coverage/index.html" />
			</report>
		</emma>
		
	</target>

	<!-- Manual test -->
		
	<target name="test-android-allwidgets" depends="pack,compile-test">

		<mkdir dir="${build.dir}/test/android"/>
		<mkdir dir="${build.dir}/test/android/allwidgets/classes"/>
			
		<!-- Copy and DEX only the relevant classes -->
		
		<copy todir="${build.dir}/test/android/allwidgets/dex-classes">
			
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/*.class"/>
				<include name="org/metawidget/android/**"/>
				<include name="org/metawidget/inspector/*.class"/>
				<include name="org/metawidget/inspector/composite/**"/>
				<include name="org/metawidget/inspector/iface/**"/>
				<include name="org/metawidget/inspector/impl/**"/>
				<include name="org/metawidget/inspector/propertytype/**"/>
				<include name="org/metawidget/inspector/java5/**"/>
				<include name="org/metawidget/inspector/xml/**"/>
				<include name="org/metawidget/mixin/base/**"/>
				<include name="org/metawidget/mixin/w3c/**"/>
				<include name="org/metawidget/util/**"/>
			</fileset>			
			<fileset dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/android/allwidgets/**"/>
				<include name="org/metawidget/test/shared/allwidgets/**/*.class"/>
			</fileset>

		</copy>
		
		<property name="android.tools.dir" value="${android.dir}/tools" />
		
        <exec executable="${android.tools.dir}/dx.bat" failonerror="true">
            <arg value="--dex" />
            <arg value="--output=${build.dir}/test/android/allwidgets/classes.dex" />
            <arg value="--positions=lines" />
            <arg path="${build.dir}/test/android/allwidgets/dex-classes" />
        </exec>

	    <!-- Put the project's resources into the output package file -->
				
        <exec executable="${android.tools.dir}/aapt.exe" failonerror="true" dir="test/android/allwidgets">
            <arg value="package" />
            <arg value="-f" />
            <arg value="-M" />
            <arg value="AndroidManifest.xml" />
            <arg value="-S" />
            <arg value="res" />
            <arg value="-I" />
            <arg value="${android.dir}/android.jar" />
            <arg value="-F" />
            <arg value="${build.dir}/test/android/allwidgets-android.ap_" />
        </exec>

	    <!-- Put the project's .dex files into the APK -->
		
        <exec executable="${android.tools.dir}/apkbuilder.bat" failonerror="true">
            <arg value="${build.dir}/test/android/allwidgets-android.apk" />
            <arg value="-z" />
            <arg value="${build.dir}/test/android/allwidgets-android.ap_" />
            <arg value="-f" />
            <arg value="${build.dir}/test/android/allwidgets/classes.dex" />
        </exec>

	</target>

	<!-- Web Test -->
		
	<target name="test-web-start-tomcat">

		<available property="tomcat-exists" file="${tomcat.dir}/bin/bootstrap.jar"/>
		<fail message="Apache Tomcat not installed at 'tomcat.dir' (as indicated in build.properties)" unless="tomcat-exists"/>

		<echo message="Starting ${tomcat.dir} (then waiting 10 seconds)..."/>
		
		<java jar="${tomcat.dir}/bin/bootstrap.jar" fork="true" spawn="true" dir="${run.dir}">
			<jvmarg value="-Dcatalina.home=${tomcat.dir}"/>
			<jvmarg value="-Duser.timezone=GMT"/>
			<jvmarg value="-Duser.region=US"/>
		</java>
		
		<sleep seconds="10"/>
		
	</target>
	
	<target name="test-web-stop-tomcat">
		
		<echo message="Stopping ${tomcat.dir} (then waiting 30 seconds)..."/>

		<java jar="${tomcat.dir}/bin/bootstrap.jar" fork="true" dir="${run.dir}">
	        <jvmarg value="-Dcatalina.home=${tomcat.dir}"/>
	        <arg line="stop"/>
	    </java>
		
		<sleep seconds="30"/>

	</target>
	
	<target name="test-faces-addressbook" depends="example-faces-addressbook,compile-test">
		
		<!-- Test on Tomcat -->

		<copy file="${build.dir}/examples/faces/addressbook-faces.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-faces"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>
		
		<antcall target="test-web-stop-tomcat"/>
		
		<!-- Test on GlassFish -->

		<delete>
			<fileset dir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy">
				<include name="addressbook-*"/>
			</fileset>
		</delete>
		<copy file="${build.dir}/examples/faces/addressbook-faces.war" todir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy" overwrite="true"/>
		<antcall target="test-web-start-glassfish"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-glassfish"/>

		<!-- Test on Jetty -->

		<copy file="${build.dir}/examples/faces/addressbook-faces.war" todir="${jetty.dir}/webapps" overwrite="true"/>
		<antcall target="test-web-start-jetty"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-jetty"/>

	</target>

	<target name="test-faces-seam-booking" depends="example-faces-seam-booking,compile-test">
		
		<ant dir="${build.dir}/examples/faces/seam/booking"/>
		<antcall target="test-web-start-jboss"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file seam-booking-test.xml"/>
		</java>

		<antcall target="test-web-stop-jboss"/>
		
	</target>

	<target name="test-faces-seam-dvdstore" depends="example-faces-seam-dvdstore,compile-test">
		
		<ant dir="${build.dir}/examples/faces/seam/dvdstore"/>
		<antcall target="test-web-start-jboss"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file seam-dvdstore-test.xml"/>
		</java>

		<antcall target="test-web-stop-jboss"/>
		
	</target>

	<target name="test-faces-seam-groovybooking" depends="example-faces-seam-groovybooking,compile-test">
		
		<ant dir="${build.dir}/examples/faces/seam/groovybooking"/>
		<antcall target="test-web-start-jboss"/>
		
		<!-- This test may require increasing the PermGen in JBoss -XX:MaxPermSize=128m -->
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file seam-groovybooking-test.xml"/>
		</java>

		<antcall target="test-web-stop-jboss"/>
		
	</target>

	<target name="test-gwt-addressbook" depends="example-gwt-addressbook,compile-test">
		
		<!-- Test on Tomcat -->
		
		<copy file="${build.dir}/examples/gwt/addressbook-gwt.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-gwt"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/gwt">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>
		
		<!-- Test on GlassFish -->

		<delete>
			<fileset dir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy">
				<include name="addressbook-*"/>
			</fileset>
		</delete>
		<copy file="${build.dir}/examples/gwt/addressbook-gwt.war" todir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy" overwrite="true"/>
		<antcall target="test-web-start-glassfish"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/gwt">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-glassfish"/>

		<!-- Test on Jetty -->

		<copy file="${build.dir}/examples/gwt/addressbook-gwt.war" todir="${jetty.dir}/webapps" overwrite="true"/>
		<antcall target="test-web-start-jetty"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/gwt">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-jetty"/>

	</target>

	<target name="test-jsp-addressbook" depends="example-jsp-addressbook,compile-test">
		
		<!-- Test on Tomcat -->
		
		<copy file="${build.dir}/examples/jsp/addressbook-jsp.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-jsp"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/jsp">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>
		
		<!-- Test on GlassFish -->

		<delete>
			<fileset dir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy">
				<include name="addressbook-*"/>
			</fileset>
		</delete>
		<copy file="${build.dir}/examples/jsp/addressbook-jsp.war" todir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy" overwrite="true"/>
		<antcall target="test-web-start-glassfish"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/jsp">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-glassfish"/>

		<!-- Test on Jetty -->

		<copy file="${build.dir}/examples/jsp/addressbook-jsp.war" todir="${jetty.dir}/webapps" overwrite="true"/>
		<antcall target="test-web-start-jetty"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/jsp">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-jetty"/>

	</target>
	
	<target name="test-struts-addressbook" depends="example-struts-addressbook,compile-test">
		
		<!-- Test on Tomcat -->
		
		<copy file="${build.dir}/examples/struts/addressbook-struts.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-struts"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/struts">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>

		<!-- Test on GlassFish -->

		<delete>
			<fileset dir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy">
				<include name="addressbook-*"/>
			</fileset>
		</delete>
		<copy file="${build.dir}/examples/struts/addressbook-struts.war" todir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy" overwrite="true"/>
		<antcall target="test-web-start-glassfish"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/struts">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-glassfish"/>

		<!-- Test on Jetty -->

		<copy file="${build.dir}/examples/struts/addressbook-struts.war" todir="${jetty.dir}/webapps" overwrite="true"/>
		<antcall target="test-web-start-jetty"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/struts">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-jetty"/>

	</target>

	<target name="test-spring-addressbook" depends="example-spring-addressbook,compile-test">
		
		<!-- Test on Tomcat -->
		
		<copy file="${build.dir}/examples/spring/addressbook-spring.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-spring"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/spring">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>
		
		<!-- Test on GlassFish -->

		<delete>
			<fileset dir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy">
				<include name="addressbook-*"/>
			</fileset>
		</delete>
		<copy file="${build.dir}/examples/spring/addressbook-spring.war" todir="${glassfish.dir}/domains/${glassfish.domain}/autodeploy" overwrite="true"/>
		<antcall target="test-web-start-glassfish"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/spring">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-glassfish"/>

		<!-- Test on Jetty -->

		<copy file="${build.dir}/examples/spring/addressbook-spring.war" todir="${jetty.dir}/webapps" overwrite="true"/>
		<antcall target="test-web-start-jetty"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/examples/spring">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file addressbook-test.xml"/>
		</java>

		<antcall target="test-web-stop-jetty"/>

	</target>

	<target name="test-swing-addressbook-applet" depends="example-swing-addressbook-applet,compile-test">
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="${run.dir}">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file '${basedir}/test/src/web/examples/swing/applet/addressbook-test.xml'"/>
		</java>
		
	</target>

	<target name="test-swing-console" depends="live-demo">

		<copy file="src/web/site/live-demo/demo.html" todir="${tomcat.dir}/webapps/ROOT/live-demo"/>
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="${run.dir}">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file '${basedir}/test/src/web/examples/swing/console-test.xml'"/>
		</java>
		
	</target>

	<available property="webtest-available" file="${webtest.dir}/webtest.xml"/>

	<target name="test-web-skip" unless="webtest-available">

		<echo level="warning" message="WebTest not installed at 'webtest.dir' in 'build.properties'. Not running web tests"/>

	</target>
	
	<target name="test-web-ok" if="webtest-available">
		
		<antcall target="test-faces-addressbook"/>
		<antcall target="test-faces-quirks"/>
		<antcall target="test-gwt-addressbook"/>
		<antcall target="test-jsp-addressbook"/>
		<antcall target="test-jsp-allwidgets"/>
		<antcall target="test-spring-addressbook"/>
		<antcall target="test-spring-quirks"/>
		<antcall target="test-struts-addressbook"/>
		<antcall target="test-struts-quirks"/>
		<antcall target="test-swing-addressbook-applet"/>					
		<antcall target="test-swing-console"/>					
		
	</target>

	<target name="test-web" depends="test-web-ok, test-web-skip"/>

	<!-- Web 1.4 Test -->

	<target name="test-web-start-tomcat4">

		<available property="tomcat4-exists" file="${tomcat4.dir}/bin/bootstrap.jar"/>
		<fail message="Apache Tomcat 4 not installed at 'tomcat4.dir' (as indicated in build.properties)" unless="tomcat4-exists"/>
		
		<available property="java4-exists" file="${java4.dir}/bin"/>
		<fail message="JDK 1.4 not installed at 'java4.dir' (as indicated in build.properties)" unless="java4-exists"/>		

		<!-- Delete work, in case of J2SE 1.4/Java 5 class version mixup -->
		
		<delete includeemptydirs="true" failonerror="false" dir="${tomcat4.dir}/work"/>
		
		<echo message="Starting ${tomcat4.dir} (then waiting 10 seconds)..."/>
		<echo message="If Tomcat 4 fails to start, try moving 'conf/server-noexamples.xml.config' to 'conf/server.xml'"/>
		
        <exec executable="${tomcat4.dir}/bin/startup.bat" dir="${run.dir}" spawn="true">
        	<env key="JAVA_HOME" value="${java4.dir}"/>
        	<env key="CATALINA_HOME" value="${tomcat4.dir}"/>
        	<env key="CATALINA_OPTS" value="-Duser.timezone=GMT -Duser.language=en -Duser.country=UK"/>
		</exec>
		
		<sleep seconds="10"/>
		
	</target>
	
	<target name="test-web-stop-tomcat4">
		
		<echo message="Stopping ${tomcat4.dir} (then waiting 30 seconds)..."/>

		<java jar="${tomcat4.dir}/bin/bootstrap.jar" fork="true" dir="${run.dir}">
	        <jvmarg value="-Dcatalina.home=${tomcat4.dir}"/>
	        <arg line="stop"/>
	    </java>
		
		<sleep seconds="30"/>

	</target>

	<!-- JBoss Test -->

	<target name="test-web-start-jboss">

		<available property="jboss-exists" file="${jboss.dir}/bin/run.bat"/>
		<fail message="JBoss not installed at 'jboss.dir' (as indicated in build.properties)" unless="jboss-exists"/>
		
		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${jboss.dir}/server/default/tmp">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${jboss.dir}/server/default/work">
				<include name="**/*"/>
			</fileset>			
		</delete>
		
		<echo message="Starting ${jboss.dir} (then waiting 30 seconds)..."/>

		<!-- Unlike for Tomcat, don't also set time zone -->
		<!-- here: seems to badly mess up Seam/Facelets  -->
		
        <exec executable="${jboss.dir}/bin/run.bat" dir="${run.dir}" spawn="true">
	    	<env key="JAVA_OPTS" value="-Duser.language=en -Duser.country=UK"/>
		</exec>
		
		<sleep seconds="30"/>
		
	</target>
	
	<target name="test-web-stop-jboss">
		
		<echo message="Stopping ${jboss.dir} (then waiting 30 seconds)..."/>
        <exec executable="${jboss.dir}/bin/shutdown.bat" dir="${run.dir}">
        	<arg value="-S"/>
		</exec>
		<sleep seconds="30"/>

	</target>

	<available property="jboss-available" file="${jboss.dir}/bin/run.bat"/>

	<target name="test-jboss-skip" unless="jboss-available">

		<echo level="warning" message="JBoss not installed at 'jboss.dir' in 'build.properties'. Not running JBoss tests"/>

	</target>
	
	<target name="test-jboss-ok" if="jboss-available">

		<antcall target="test-faces-seam-booking"/>
		<antcall target="test-faces-seam-dvdstore"/>
		<antcall target="test-faces-seam-groovybooking"/>
		
	</target>

	<target name="test-jboss" depends="test-jboss-ok, test-jboss-skip"/>

	<!-- GlassFish Tests -->
	
	<!-- (if GlassFish fails intermittently, try setting com.sun.enterprise.server.ss.setReuseAddress -->
	<!--  to true as discussed here http://forums.java.net/jive/message.jspa?messageID=172574)        -->

	<target name="test-web-start-glassfish">

		<available property="glassfish-exists" file="${glassfish.dir}/bin/asadmin.bat"/>
		<fail message="GlassFish not installed at 'glassfish.dir' (as indicated in build.properties)" unless="glassfish-exists"/>
		
		<echo message="Starting ${glassfish.dir} (then waiting 50 seconds)..."/>

        <exec executable="${glassfish.dir}/bin/asadmin.bat" dir="${run.dir}" spawn="true">
        	<arg value="start-domain"/>
        	<arg value="${glassfish.domain}"/>
		</exec>
		
		<sleep seconds="50"/>
		
	</target>
	
	<target name="test-web-stop-glassfish">
		
		<echo message="Stopping ${glassfish.dir} (then waiting 30 seconds)..."/>
        <exec executable="${glassfish.dir}/bin/asadmin.bat" dir="${run.dir}">
        	<arg value="stop-domain"/>
        	<arg value="${glassfish.domain}"/>
		</exec>
		<sleep seconds="30"/>

	</target>

	<!-- Jetty Tests -->

	<target name="test-web-start-jetty">

		<available property="jetty-exists" file="${jetty.dir}/start.jar"/>
		<fail message="Jetty not installed at 'jetty.dir' (as indicated in build.properties)" unless="jetty-exists"/>
		
		<echo message="Starting ${jetty.dir} (then waiting 30 seconds)..."/>

		<java jar="${jetty.dir}/start.jar" fork="true" spawn="true" dir="${run.dir}">
			<jvmarg value="-Djetty.home=${jetty.dir}"/>
			<jvmarg value="-Duser.timezone=GMT"/>
			<jvmarg value="-Duser.region=US"/>
			<jvmarg value="-DSTOP.PORT=8079"/>
			<jvmarg value="-DSTOP.KEY=secret"/>
		</java>

		<sleep seconds="30"/>
		
	</target>
	
	<target name="test-web-stop-jetty">
		
		<echo message="Stopping ${jetty.dir} (then waiting 30 seconds)..."/>
		<java jar="${jetty.dir}/start.jar" fork="true" dir="${run.dir}">
			<jvmarg value="-Djetty.home=${jetty.dir}"/>
			<jvmarg value="-DSTOP.PORT=8079"/>
			<jvmarg value="-DSTOP.KEY=secret"/>
			<arg value="--stop"/>
		</java>
		<sleep seconds="30"/>

	</target>

	<!-- AllWidgets tests -->
	
	<target name="test-shared-allwidgets" depends="flatten-libs,compile-test">

		<copy todir="${build.dir}/test-classes">
			<fileset dir="test/src/java">
				<include name="org/metawidget/test/shared/allwidgets/**/*.properties"/>
				<include name="org/metawidget/test/shared/allwidgets/**/metawidget-metadata.xml"/>
			</fileset>
		</copy>

	</target>
		
	<target name="test-faces-allwidgets" depends="test-shared-allwidgets">
		
		<mkdir dir="${build.dir}/test/faces"/>

		<war warfile="${build.dir}/test/faces/allwidgets-faces.war" webxml="test/src/web/faces/allwidgets/WEB-INF/web.xml">
			<fileset dir="test/src/web/faces/allwidgets">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/faces/allwidgets/**"/>
				<include name="org/metawidget/test/shared/allwidgets/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-codec-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-el-*.jar"/>
				<include name="commons-lang-*.jar"/>
				<include name="jsp-2.0.jar"/>
				<include name="jstl-*.jar"/>
				<include name="metawidget.jar"/>
				<include name="myfaces-*-1.1*.jar"/>
				<include name="richfaces-*.jar"/>
			</lib>
		</war>
		
		<copy file="${build.dir}/test/faces/allwidgets-faces.war" todir="${tomcat4.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat4.dir}/webapps/allwidgets-faces"/>
		<antcall target="test-web-start-tomcat4"/>
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file allwidgets-test.xml"/>
		</java>
		
		<antcall target="test-web-stop-tomcat4"/>
		
	</target>

	<target name="test-faces-quirks" depends="flatten-libs,compile-test">
		
		<mkdir dir="${build.dir}/test/faces"/>

		<war warfile="${build.dir}/test/faces/quirks-faces.war" webxml="test/src/web/faces/quirks/WEB-INF/web.xml">
			<fileset dir="test/src/web/faces/quirks">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/faces/quirks/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-codec-*.jar"/>
				<include name="commons-collections-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-discovery-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="metawidget.jar"/>
				<include name="myfaces-*-1.2*.jar"/>
				<include name="standard.jar"/>
			</lib>
		</war>
		
		<copy file="${build.dir}/test/faces/quirks-faces.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/quirks-faces"/>
		<antcall target="test-web-start-tomcat"/>
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/faces">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file quirks-test.xml"/>
		</java>
		
		<antcall target="test-web-stop-tomcat"/>
		
	</target>

	<target name="test-jsp-allwidgets" depends="test-shared-allwidgets">
		
		<mkdir dir="${build.dir}/test/jsp"/>

		<war warfile="${build.dir}/test/jsp/allwidgets-jsp.war" webxml="test/src/web/jsp/allwidgets/WEB-INF/web.xml">
			<fileset dir="test/src/web/jsp/allwidgets">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/jsp/allwidgets/**"/>
				<include name="org/metawidget/test/shared/allwidgets/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="jstl-*.jar"/>
				<include name="metawidget.jar"/>
				<include name="standard.jar"/>
			</lib>
		</war>
		
		<!-- Use tomcat, not tomcat4, because we need JSP 2.0 to test EL -->

		<copy file="${build.dir}/test/jsp/allwidgets-jsp.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/allwidgets-jsp"/>
		<delete dir="${tomcat.dir}/webapps/addressbook-jsp"/>
		<delete file="${tomcat.dir}/webapps/addressbook-jsp.war"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/jsp">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file allwidgets-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>
		
	</target>

	<target name="test-spring-allwidgets" depends="test-shared-allwidgets">
		
		<mkdir dir="${build.dir}/test/spring"/>

		<war warfile="${build.dir}/test/spring/allwidgets-spring.war" webxml="test/src/web/spring/allwidgets/WEB-INF/web.xml">
			<fileset dir="test/src/web/spring/allwidgets">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/spring/allwidgets/**"/>
				<include name="org/metawidget/test/shared/allwidgets/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="spring.jar"/>
				<include name="spring-*.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy file="${build.dir}/test/spring/allwidgets-spring.war" todir="${tomcat4.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat4.dir}/webapps/allwidgets-spring"/>
		<antcall target="test-web-start-tomcat4"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/spring">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file allwidgets-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat4"/>
		
	</target>
	
	<target name="test-spring-quirks" depends="flatten-libs,compile-test">
		
		<mkdir dir="${build.dir}/test/spring"/>

		<war warfile="${build.dir}/test/spring/quirks-spring.war" webxml="test/src/web/spring/quirks/WEB-INF/web.xml">
			<fileset dir="test/src/web/spring/quirks">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/spring/quirks/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="spring.jar"/>
				<include name="spring-*.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy file="${build.dir}/test/spring/quirks-spring.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/quirks-spring"/>
		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/spring">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file quirks-test.xml"/>
		</java>

		<antcall target="test-web-stop-tomcat"/>
		
	</target>

	<target name="test-struts-allwidgets" depends="test-shared-allwidgets">
		
		<mkdir dir="${build.dir}/test/struts"/>

		<war warfile="${build.dir}/test/struts/allwidgets-struts.war" webxml="test/src/web/struts/allwidgets/WEB-INF/web.xml">
			<fileset dir="test/src/web/struts/allwidgets">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/struts/allwidgets/**"/>
				<include name="org/metawidget/test/shared/allwidgets/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="struts.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy file="${build.dir}/test/struts/allwidgets-struts.war" todir="${tomcat4.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat4.dir}/webapps/allwidgets-struts"/>
		<antcall target="test-web-start-tomcat4"/>
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/struts">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file allwidgets-test.xml"/>
		</java>
			
		<antcall target="test-web-stop-tomcat4"/>
		
	</target>

	<target name="test-struts-quirks" depends="flatten-libs,compile-test">
		
		<mkdir dir="${build.dir}/test/struts"/>

		<war warfile="${build.dir}/test/struts/quirks-struts.war" webxml="test/src/web/struts/quirks/WEB-INF/web.xml">
			<fileset dir="test/src/web/struts/quirks">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<classes dir="${build.dir}/test-classes">
				<include name="org/metawidget/test/struts/quirks/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="struts.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy file="${build.dir}/test/struts/quirks-struts.war" todir="${tomcat.dir}/webapps" overwrite="true"/>
		<delete dir="${tomcat.dir}/webapps/quirks-struts"/>
		<antcall target="test-web-start-tomcat"/>
		
		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/struts">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file quirks-test.xml"/>
		</java>
			
		<antcall target="test-web-stop-tomcat"/>
		
	</target>

	<available property="tomcat4-available" file="${tomcat4.dir}/bin/bootstrap.jar"/>

	<target name="test-web4-skip" unless="tomcat4-available">

		<echo level="warning" message="Tomcat4 not installed at 'tomcat4.dir' in 'build.properties'. Not running J2SE 1.4 web tests"/>

	</target>
	
	<target name="test-web4-ok" if="tomcat4-available">

		<available property="webtest-available" file="${webtest.dir}/webtest.xml"/>
		<fail message="WebTest not installed at 'webtest.dir' in 'build.properties'. Not running web tests" unless="webtest-available"/>
		
		<antcall target="test-faces-allwidgets"/>
		<antcall target="test-spring-allwidgets"/>
		<antcall target="test-struts-allwidgets"/>
		
	</target>

	<target name="test-web4" depends="test-web4-ok, test-web4-skip"/>
	
	<target name="test" depends="test-web, test-web4, test-jboss, test-unit"/>
	
	<!-- Examples -->

	<target name="example-swing-addressbook" depends="pack,compile-examples">
		
		<mkdir dir="${build.dir}/examples/swing"/>

		<jar jarfile="${build.dir}/examples/swing/addressbook-swing.jar" manifest="examples/src/java/org/metawidget/example/swing/addressbook/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/swing/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</fileset>
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/shared/addressbook/media/*.jpg"/>
				<include name="org/metawidget/example/shared/addressbook/media/*.gif"/>
				<include name="org/metawidget/example/shared/addressbook/**/*.properties"/>
				<include name="org/metawidget/example/swing/addressbook/*.xml"/>
			</fileset>
		</jar>		

		<copy todir="${build.dir}/examples/swing">
			<fileset dir="examples/src/java/org/metawidget/example/swing">
				<include name="readme.txt"/>
			</fileset>
			<fileset dir=".">
				<include name="lib\beansbinding*.jar"/>
			</fileset>
		</copy>
		
	</target>

	<target name="example-swing-addressbook-applet" depends="compile-examples">
		
		<mkdir dir="${build.dir}/examples/swing/applet/addressbook"/>

		<jar destfile="${build.dir}/examples/swing/applet/addressbook/metawidget-applet.jar" manifest="src/java/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/*.class"/>
				<include name="org/metawidget/swing/*.class"/>
				<include name="org/metawidget/swing/actionbinding/*.class"/>
				<include name="org/metawidget/swing/actionbinding/reflection/*.class"/>
				<include name="org/metawidget/swing/propertybinding/*.class"/>
				<include name="org/metawidget/swing/propertybinding/beansbinding/*.class"/>
				<include name="org/metawidget/swing/layout/*.class"/>
				<include name="org/metawidget/inspector/*.class"/>
				<include name="org/metawidget/inspector/annotation/**"/>
				<include name="org/metawidget/inspector/commons/jexl/**"/>				
				<include name="org/metawidget/inspector/composite/**"/>
				<include name="org/metawidget/inspector/iface/**"/>
				<include name="org/metawidget/inspector/impl/*.class"/>
				<include name="org/metawidget/inspector/impl/actionstyle/*.class"/>
				<include name="org/metawidget/inspector/impl/actionstyle/metawidget/*.class"/>
				<include name="org/metawidget/inspector/impl/propertystyle/*.class"/>
				<include name="org/metawidget/inspector/impl/propertystyle/javabean/*.class"/>
				<include name="org/metawidget/inspector/propertytype/**"/>
				<include name="org/metawidget/inspector/java5/**"/>				
				<include name="org/metawidget/inspector/xml/**"/>				
				<include name="org/metawidget/mixin/base/**"/>
				<include name="org/metawidget/mixin/w3c/**"/>
				<include name="org/metawidget/util/**"/>
			</fileset>
			<fileset dir="src/java">			
				<include name="**/*.xsd"/>
			</fileset>
		</jar>
		
		<jar jarfile="${build.dir}/examples/swing/applet/addressbook/addressbook-swing-applet.jar">
			<fileset dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/swing/applet/**"/>
				<include name="org/metawidget/example/swing/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</fileset>
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/shared/addressbook/media/*.jpg"/>
				<include name="org/metawidget/example/shared/addressbook/media/*.gif"/>
				<include name="org/metawidget/example/shared/addressbook/**/*.properties"/>
				<include name="org/metawidget/example/swing/addressbook/*.xml"/>
			</fileset>
		</jar>		

		<taskdef name="pack200" classname="com.sun.tools.apache.ant.pack200.Pack200Task" classpath="lib/Pack200Task.jar"/>
		<pack200 src="${build.dir}/examples/swing/applet/addressbook/metawidget-applet.jar" destfile="${build.dir}/examples/swing/applet/addressbook/metawidget-applet.jar.pack"/>		
		<pack200 src="${build.dir}/examples/swing/applet/addressbook/addressbook-swing-applet.jar" destfile="${build.dir}/examples/swing/applet/addressbook/addressbook-swing-applet.jar.pack"/>		
		
		<copy todir="${build.dir}/examples/swing/applet/addressbook">
			<fileset dir="examples/src/web/swing/applet/addressbook"/>
			<fileset dir="lib">
				<include name="beansbinding*.jar"/>
				<include name="commons-jexl-*.jar"/>
				<include name="commons-logging-*.jar"/>
			</fileset>			
		</copy>

		<copy todir="${build.dir}/examples/swing" file="examples/src/java/org/metawidget/example/swing/readme.txt"/>

	</target>

	<target name="example-swing-appframework" depends="pack,compile-examples">
		
		<mkdir dir="${build.dir}/examples/swing"/>

		<jar jarfile="${build.dir}/examples/swing/appframework-swing.jar" manifest="examples/src/java/org/metawidget/example/swing/appframework/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/swing/appframework/**"/>
			</fileset>
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/swing/appframework/resources/*.properties"/>
				<include name="org/metawidget/example/swing/appframework/*.xml"/>
			</fileset>
		</jar>		

		<copy todir="${build.dir}/examples/swing">
			<fileset dir="examples/src/java/org/metawidget/example/swing">
				<include name="readme.txt"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/swing/appframework">
				<include name="lib/swing-worker.jar"/>
			</fileset>
			<fileset dir=".">
				<include name="lib/AppFramework.jar"/>
				<include name="lib/beansbinding*.jar"/>
				<include name="lib/commons-jexl-*.jar"/>
				<include name="lib/commons-logging-*.jar"/>
			</fileset>
		</copy>
		
	</target>

	<target name="example-swing-animalraces" depends="pack,compile-examples">
		
		<mkdir dir="${build.dir}/examples/swing"/>

		<jar jarfile="${build.dir}/examples/swing/animalraces-swing.jar" manifest="examples/src/scala/org/metawidget/example/swing/animalraces/META-INF/MANIFEST.MF">
			<fileset dir="${build.dir}/scala-example-classes">
				<include name="org/metawidget/example/swing/animalraces/**"/>
			</fileset>
			<fileset dir="examples/src/scala">
				<include name="org/metawidget/example/swing/animalraces/*.xml"/>
				<include name="org/metawidget/example/swing/animalraces/media/**"/>
			</fileset>
		</jar>		

		<copy todir="${build.dir}/examples/swing">
			<fileset dir="examples/src/java/org/metawidget/example/swing">
				<include name="readme.txt"/>
			</fileset>
			<fileset dir=".">
				<include name="lib/beansbinding*.jar"/>
				<include name="lib/commons-beanutils-*.jar"/>
				<include name="lib/commons-logging-*.jar"/>
				<include name="lib/scala-library.jar"/>
				<include name="lib/miglayout-*.jar"/>
			</fileset>
		</copy>
		
	</target>

	<target name="examples-desktop" depends="example-swing-addressbook, example-swing-addressbook-applet, example-swing-appframework, example-swing-animalraces"/>
		
	<target name="example-shared-addressbook" depends="flatten-libs">
		
		<copy todir="${build.dir}/examples/src/web/shared/addressbook" failonerror="false" >
			<fileset dir="examples/src/web/struts/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
		</copy>

		<copy todir="${build.dir}/example-classes">
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/shared/addressbook/**/*.properties"/>
			</fileset>
		</copy>

	</target>

	<target name="example-faces-addressbook" depends="example-shared-addressbook">

		<mkdir dir="${build.dir}/examples/faces"/>

		<war warfile="${build.dir}/examples/faces/addressbook-faces.war" webxml="examples/src/web/faces/addressbook/WEB-INF/web.xml">
			<fileset dir="examples/src/web/faces/addressbook">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="css/**"/>
				<exclude name="WEB-INF/tags/**"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<fileset dir="${build.dir}/examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/shared/addressbook">
				<include name="media/**"/>
			</fileset>
			<classes dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/faces/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-codec-*.jar"/>
				<include name="commons-collections-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-discovery-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="hibernate-validator*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="metawidget.jar"/>
				<include name="myfaces-*-1.2*.jar"/>
				<include name="richfaces-*.jar"/>
				<include name="standard.jar"/>
			</lib>
		</war>

		<copy todir="${build.dir}/examples/faces" file="examples/src/web/faces/readme.txt"/>

	</target>
	
	<target name="example-faces-seam-booking" depends="pack-as-frontend-backend,compile-examples">
		
		<copy todir="${build.dir}/examples/faces">
			<fileset dir="examples/src/web/faces">
				<include name="seam/booking/**"/>
			</fileset>
		</copy>

		<copy todir="${build.dir}/examples/faces/seam/booking" file="${build.dir}/metawidget-frontend.jar"/>
		<copy todir="${build.dir}/examples/faces/seam/booking" file="${build.dir}/metawidget-backend.jar"/>

		<copy todir="${build.dir}/examples/faces" file="examples/src/web/faces/readme.txt"/>

	</target>

	<target name="example-faces-seam-dvdstore" depends="pack-as-frontend-backend,compile-examples">
		
		<copy todir="${build.dir}/examples/faces">
			<fileset dir="examples/src/web/faces">
				<include name="seam/dvdstore/**"/>
			</fileset>
		</copy>

		<copy todir="${build.dir}/examples/faces/seam/dvdstore" file="${build.dir}/metawidget-frontend.jar"/>
		<copy todir="${build.dir}/examples/faces/seam/dvdstore" file="${build.dir}/metawidget-backend.jar"/>

		<copy todir="${build.dir}/examples/faces" file="examples/src/web/faces/readme.txt"/>

	</target>

	<target name="example-faces-seam-groovybooking" depends="pack,compile-examples">
		
		<copy todir="${build.dir}/examples/faces">
			<fileset dir="examples/src/web/faces">
				<include name="seam/groovybooking/**"/>
			</fileset>
		</copy>

		<!-- Groovy example uses metawidget.jar, not metawidget-*.jar -->
		
		<copy todir="${build.dir}/examples/faces/seam/groovybooking">
			<fileset dir="lib">
				<include name="groovy*.jar"/>
			</fileset>
		</copy>

		<copy todir="${build.dir}/examples/faces" file="examples/src/web/faces/readme.txt"/>

	</target>

	<target name="example-jsp-addressbook" depends="example-shared-addressbook">

		<mkdir dir="${build.dir}/examples/jsp"/>

		<war warfile="${build.dir}/examples/jsp/addressbook-jsp.war" webxml="examples/src/web/jsp/addressbook/WEB-INF/web.xml">
			<fileset dir="examples/src/web/jsp/addressbook">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="css/**"/>
				<exclude name="WEB-INF/tags/**"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<fileset dir="${build.dir}/examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/shared/addressbook">
				<include name="media/**"/>
			</fileset>
			<classes dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/jsp/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="jstl-*.jar"/>
				<include name="standard.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy todir="${build.dir}/examples/jsp" file="examples/src/web/jsp/readme.txt"/>
		
	</target>

	<target name="example-struts-addressbook" depends="example-shared-addressbook">

		<mkdir dir="${build.dir}/examples/struts"/>

		<war warfile="${build.dir}/examples/struts/addressbook-struts.war" webxml="examples/src/web/struts/addressbook/WEB-INF/web.xml">
			<fileset dir="examples/src/web/struts/addressbook">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="css/**"/>
				<exclude name="WEB-INF/tags/**"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<fileset dir="${build.dir}/examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/shared/addressbook">
				<include name="media/**"/>
			</fileset>
			<classes dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/struts/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-beanutils-*.jar"/>
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="commons-validator*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="struts.jar"/>
				<include name="standard.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy todir="${build.dir}/examples/struts" file="examples/src/web/struts/readme.txt"/>

	</target>

	<target name="example-spring-addressbook" depends="example-shared-addressbook">

		<mkdir dir="${build.dir}/examples/spring"/>

		<war warfile="${build.dir}/examples/spring/addressbook-spring.war" webxml="examples/src/web/spring/addressbook/WEB-INF/web.xml">
			<fileset dir="examples/src/web/spring/addressbook">
				<exclude name="**/classes/**"/>
				<exclude name="**/lib/**"/>
				<exclude name="**/.*"/>
				<exclude name="css/**"/>
				<exclude name="WEB-INF/tags/**"/>
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
			<fileset dir="${build.dir}/examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/shared/addressbook">
				<include name="media/**"/>
			</fileset>
			<classes dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/spring/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="commons-digester-*.jar"/>
				<include name="commons-logging-*.jar"/>
				<include name="jstl-*.jar"/>
				<include name="spring.jar"/>
				<include name="spring-*.jar"/>
				<include name="standard.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>

		<copy todir="${build.dir}/examples/spring" file="examples/src/web/spring/readme.txt"/>
		
	</target>

	<target name="example-gwt-addressbook" depends="example-shared-addressbook, pack-gwt-client">
		
		<!-- GWT compiler -->

		<mkdir dir="${build.dir}/gwt-classes"/>
		<mkdir dir="${build.dir}/gwt-example-src"/>

		<copy todir="${build.dir}/gwt-example-src">
			<fileset dir="examples/src/java">
				<include name="org/metawidget/example/*.gwt.xml"/>
				<include name="org/metawidget/example/gwt/addressbook/client/**"/>
				<include name="org/metawidget/example/gwt/addressbook/inspector/remote/client/**"/>
				<include name="org/metawidget/example/shared/addressbook/model/**"/>
			</fileset>			
		</copy>
		
		<mkdir dir="${build.dir}/examples/gwt"/>
		<copy todir="${build.dir}/examples/gwt" file="${build.dir}/metawidget-gwt-client.jar"/>
		
		<java dir="${build.dir}" classname="com.google.gwt.dev.GWTCompiler" fork="yes" failonerror="true">
			<classpath>
				<dirset dir="${build.dir}/gwt-example-src"/>
				<fileset dir="lib"/>
				<fileset dir="${build.dir}">
					<include name="metawidget.jar"/>
				</fileset>
				<fileset dir="${build.dir}/examples/gwt">
					<include name="metawidget-gwt-client.jar"/>
				</fileset>
			</classpath>
			<jvmarg value="-Xmx256M"/>
			<arg value="-out" />
			<arg file="${build.dir}/gwt-classes" />
			<arg value="org.metawidget.example.GwtAddressBook" />
		</java>
		
		<!-- Create the WAR -->
			
		<war file="${build.dir}/examples/gwt/addressbook-gwt.war" webxml="examples/src/web/gwt/addressbook/WEB-INF/web.xml">
			<fileset dir="${build.dir}/gwt-classes/org.metawidget.example.GwtAddressBook"/>
			<fileset dir="examples/src/web/gwt/addressbook">
				<exclude name="**/lib/**"/>
			</fileset>
			<fileset dir="${build.dir}/examples/src/web/shared/addressbook">
				<include name="css/**"/>
				<include name="WEB-INF/tags/**"/>
			</fileset>
			<fileset dir="examples/src/java/org/metawidget/example/shared/addressbook">
				<include name="media/**"/>
			</fileset>
			<classes dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/gwt/addressbook/client/rpc/ContactsService.class"/>
				<include name="org/metawidget/example/gwt/addressbook/server/**"/>
				<include name="org/metawidget/example/shared/addressbook/**"/>
			</classes>
			<lib dir="${build.dir}/lib">
				<include name="gwt-servlet.jar"/>
				<include name="jstl-*.jar"/>
				<include name="standard.jar"/>
				<include name="metawidget.jar"/>
			</lib>
		</war>
		
		<copy todir="${build.dir}/examples/gwt" file="examples/src/web/gwt/readme.txt"/>

	</target>
	
	<target name="examples-web" depends="example-faces-addressbook, example-faces-seam-booking, example-faces-seam-dvdstore, example-faces-seam-groovybooking, example-gwt-addressbook, example-jsp-addressbook, example-spring-addressbook, example-struts-addressbook"/>

	<available property="android-available" file="${android.dir}/tools/dx.bat"/>
	
	<target name="example-android-skip" depends="pack" unless="android-available">
		
		<echo level="warning" message="Android not installed at 'android.dir' in 'build.properties'. Building examples without Android examples"/>
		
	</target>

	<target name="example-android-addressbook" depends="pack,compile-examples" if="android-available">

		<mkdir dir="${build.dir}/examples/android"/>
		<mkdir dir="${build.dir}/examples/android/addressbook/dex-classes"/>
			
		<!-- Copy and DEX only the relevant classes -->
		
		<copy todir="${build.dir}/examples/android/addressbook/dex-classes">
			
			<fileset dir="${build.dir}/classes">
				<include name="org/metawidget/*.class"/>				
				<include name="org/metawidget/android/**"/>
				<include name="org/metawidget/inspector/*.class"/>
				<include name="org/metawidget/inspector/annotation/**"/>
				<include name="org/metawidget/inspector/composite/**"/>
				<include name="org/metawidget/inspector/iface/**"/>
				<include name="org/metawidget/inspector/impl/**"/>
				<include name="org/metawidget/inspector/propertytype/**"/>
				<include name="org/metawidget/inspector/java5/**"/>
				<include name="org/metawidget/inspector/xml/**"/>
				<include name="org/metawidget/mixin/base/**"/>
				<include name="org/metawidget/mixin/w3c/**"/>
				<include name="org/metawidget/util/**"/>
			</fileset>
			<fileset dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/android/addressbook/**"/>
				<include name="org/metawidget/example/shared/addressbook/**/*.class"/>
			</fileset>

		</copy>
		
		<property name="android.tools.dir" value="${android.dir}/tools" />
		
        <exec executable="${android.tools.dir}/dx.bat" failonerror="true">
            <arg value="--dex" />
            <arg value="--output=${basedir}/${build.dir}/examples/android/addressbook/classes.dex" />
            <arg value="--positions=lines" />
            <arg path="${basedir}/${build.dir}/examples/android/addressbook/dex-classes" />
        </exec>

	    <!-- Put the project's resources into the output package file -->
				
        <exec executable="${android.tools.dir}/aapt.exe" failonerror="true" dir="examples/src/android/addressbook">
            <arg value="package" />
            <arg value="-f" />
            <arg value="-M" />
            <arg value="AndroidManifest.xml" />
            <arg value="-S" />
            <arg value="res" />
            <arg value="-I" />
            <arg value="${android.dir}/android.jar" />
            <arg value="-F" />
            <arg value="${basedir}/${build.dir}/examples/android/addressbook-android.ap_" />
        </exec>

	    <!-- Put the project's .dex files into the APK -->
		
        <exec executable="${android.tools.dir}/apkbuilder.bat" failonerror="true">        
            <arg value="${basedir}/${build.dir}/examples/android/addressbook-android.apk" />
            <arg value="-z" />
            <arg value="${basedir}/${build.dir}/examples/android/addressbook-android.ap_" />
            <arg value="-f" />
            <arg value="${basedir}/${build.dir}/examples/android/addressbook/classes.dex" />
        </exec>

		<copy todir="${build.dir}/examples/android" file="examples/src/java/org/metawidget/example/android/readme.txt"/>

	</target>
	
	<target name="examples-mobile" depends="example-android-addressbook, example-android-skip" />
	
	<target name="examples" depends="examples-desktop, examples-web, examples-mobile"/>

	<!-- http://www.metawidget.org -->

	<target name="live-demo" depends="pack,compile-examples">
		
		<delete failonerror="false">
			<fileset dir="${tomcat.dir}/webapps/ROOT/live-demo">
				<include name="*.jar"/>
				<include name="*.jar.pack"/>
			</fileset>			
		</delete>
		<mkdir dir="${tomcat.dir}/webapps/ROOT/live-demo"/>
		<mkdir dir="${build.dir}/website"/>
		
		<jar destfile="${build.dir}/website/console-applet.jar">
			<fileset dir="${build.dir}/example-classes">
				<include name="org/metawidget/example/swing/console/**"/>
			</fileset>
		</jar>
		
		<taskdef name="pack200" classname="com.sun.tools.apache.ant.pack200.Pack200Task" classpath="lib/Pack200Task.jar"/>
		<pack200 repack="true" src="${build.dir}/website/console-applet.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar"/>		
		<pack200 repack="true" src="${build.dir}/metawidget.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar"/>		
		<copy todir="${tomcat.dir}/webapps/ROOT/live-demo">
			<fileset dir="lib">
				<include name="ejb3-persistence.jar"/>
				<include name="groovy*.jar"/>
				<include name="hibernate-validator.jar"/>
			</fileset>
		</copy>		

		<signjar alias="Metawidget" keystore="examples/src/java/org/metawidget/example/swing/console/metawidget.keystore" storepass="m3t4w1dg3t">
			<path>
				<fileset dir="${tomcat.dir}/webapps/ROOT/live-demo">
					<include name="console-applet.jar*"/>
					<include name="metawidget.jar*"/>
					<include name="groovy*.jar*"/>
				</fileset>				
			</path>
		</signjar>

		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/console-applet.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/metawidget.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/ejb3-persistence.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/ejb3-persistence.jar.pack"/>		
		<pack200 src="${tomcat.dir}/webapps/ROOT/live-demo/hibernate-validator.jar" destfile="${tomcat.dir}/webapps/ROOT/live-demo/hibernate-validator.jar.pack"/>		

	</target>
	
	<target name="web-site">

		<delete dir="${tomcat.dir}/webapps"/>

		<!-- JSP version -->

		<copy todir="${build.dir}/lib" flatten="true" includeemptydirs="false">
			<fileset dir="lib"/>
			<fileset dir="examples/src/web">
				<include name="**/lib/**"/>
			</fileset>
		</copy>

		<copy todir="${tomcat.dir}/webapps/ROOT">
			<fileset dir="src/web/site"/>
		</copy>
			
		<copy todir="${tomcat.dir}/webapps/ROOT/WEB-INF/lib">
			<fileset dir="${build.dir}/lib">
				<include name="jstl-*.jar"/>
				<include name="standard.jar"/>
			</fileset>
		</copy>

		<!-- Extract HTML -->

		<available property="httrack-exists" file="${httrack.dir}/httrack.exe"/>
		<fail message="HTTrack not installed at 'httrack.dir' (as indicated in build.properties)" unless="httrack-exists"/>

		<antcall target="test-web-start-tomcat"/>
		<sleep seconds="30"/>
		<delete dir="${build.dir}/website"/>
		
		<exec executable="${httrack.dir}/httrack.exe" failonerror="false" failifexecutionfails="false" >
			<arg value="${webtest.url}"/>
			<arg value="--path"/>
			<arg value="${build.dir}/website"/>
			<arg value="--keep-links=4"/>
			<arg value="--footer"/>
			<arg value="&quot;&quot;"/>
		</exec>

		<antcall target="test-web-stop-tomcat"/>
		<delete dir="${tomcat.dir}/webapps"/>		

		<move todir="${tomcat.dir}/webapps/ROOT">
			<fileset dir="${build.dir}/website/localhost_8080"/>
		</move>
	
		<!-- Doco -->

		<antcall target="docbook"/>
		<antcall target="javadoc"/>
		<antcall target="tlddoc"/>

		<copy todir="${tomcat.dir}/webapps/ROOT" overwrite="true">			
			<fileset dir="${build.dir}">
				<include name="doc/api/**"/>
				<include name="doc/coverage/**"/>
				<include name="doc/taglib/**"/>
				<include name="doc/reference/**/html*/*.html"/>
				<include name="doc/reference/**/pdf/*.pdf"/>
				<include name="doc/**/shared/**"/>
			</fileset>
		</copy>

		<!-- Try to have something at the XSD and TLD URIs -->
		
		<copy file="src/java/org/metawidget/inspector/inspector-config-1.0.xsd" tofile="${tomcat.dir}/webapps/ROOT/inspector-config/index.html"/>
		<copy file="src/java/org/metawidget/inspector/inspector-config-1.0.xsd" todir="${tomcat.dir}/webapps/ROOT/inspector-config"/>
		<copy file="src/java/org/metawidget/inspector/inspection-result-1.0.xsd" tofile="${tomcat.dir}/webapps/ROOT/inspection-result/index.html"/>
		<copy file="src/java/org/metawidget/inspector/inspection-result-1.0.xsd" todir="${tomcat.dir}/webapps/ROOT/inspection-result"/>
		<copy file="src/java/META-INF/metawidget-faces.tld" tofile="${tomcat.dir}/webapps/ROOT/faces/index.html"/>
		<copy file="src/java/META-INF/metawidget-faces.tld" todir="${tomcat.dir}/webapps/ROOT/faces"/>
		<copy file="src/java/META-INF/metawidget-richfaces.tld" tofile="${tomcat.dir}/webapps/ROOT/faces/richfaces/index.html"/>
		<copy file="src/java/META-INF/metawidget-richfaces.tld" todir="${tomcat.dir}/webapps/ROOT/faces/richfaces"/>
		<copy file="src/java/META-INF/metawidget-html.tld" tofile="${tomcat.dir}/webapps/ROOT/html/index.html"/>
		<copy file="src/java/META-INF/metawidget-html.tld" todir="${tomcat.dir}/webapps/ROOT/html"/>
		<copy file="src/java/META-INF/metawidget-spring.tld" tofile="${tomcat.dir}/webapps/ROOT/spring/index.html"/>
		<copy file="src/java/META-INF/metawidget-spring.tld" todir="${tomcat.dir}/webapps/ROOT/spring"/>
		<copy file="src/java/META-INF/metawidget-struts.tld" tofile="${tomcat.dir}/webapps/ROOT/struts/index.html"/>
		<copy file="src/java/META-INF/metawidget-struts.tld" todir="${tomcat.dir}/webapps/ROOT/struts"/>

		<!-- (SourceForge runs on UNIX, and we want to keep file sizes the same for easy diffs) -->

		<fixcrlf srcdir="${tomcat.dir}/webapps/ROOT" eol="unix">
			<include name="**/*.css"/>
			<include name="**/*.html"/>
			<include name="**/*.js"/>
		</fixcrlf>
		
		<!-- JavaScript images tend to get missed by httrack -->
			
		<copy todir="${tomcat.dir}/webapps/ROOT/media">
			<fileset dir="src/web/site/media"/>
		</copy>

		<!-- Live demo -->

		<antcall target="live-demo"/>
		
		<!-- Test HTML links

		<antcall target="test-web-start-tomcat"/>

		<java classname="org.apache.tools.ant.Main" failonerror="true" fork="true" dir="test/src/web/site">
			<classpath>
				<fileset dir="${ant.home}">
					<include name="lib/*.jar"/>
				</fileset>
			</classpath>
			<arg line="-file test.xml"/>
		</java>
		
		<antcall target="test-web-stop-tomcat"/> -->

	</target>
	
	<!-- Dist -->

	<target name="dist" depends="clean, pack, javadoc, tlddoc, docbook, examples">

		<!-- Source -->
		
		<mkdir dir="${build.dir}/${metawidget.name}"/>

		<copy todir="${build.dir}/${metawidget.name}">
			<fileset dir=".">
				
				<include name="lib/**"/>
				<include name="src/**"/>
				<include name="test/**"/>
				<include name="build.xml"/>
				<include name="build.properties"/>
				<include name="documentation.html"/>
				<include name="lgpl.txt"/>
				<include name="readme.txt"/>
				
				<include name="examples/**"/>

				<!-- Shared example resources. This stops them being scattered and duplicated -->
				<!-- all over the ZIP. However, scattering and duplicating is useful for some -->
				<!-- IDE deployers, such as MyEclipse                                         -->
				
				<exclude name="examples/src/web/**/css/**"/>				
				<exclude name="examples/src/web/**/media/**"/>				
				<exclude name="examples/src/web/**/WEB-INF/tags/**"/>				
				<include name="examples/src/web/shared/addressbook/css/**"/>
				<include name="examples/src/web/shared/addressbook/WEB-INF/tags/**"/>				
				<exclude name="**/WEB-INF/classes/**"/>
				<exclude name="**/.p4ignore"/>
			</fileset>
			<fileset dir="${build.dir}">
				<include name="debug/**"/>
				<include name="doc/api/**"/>
				<include name="doc/coverage/**"/>
				<include name="doc/taglib/**"/>
				<include name="doc/reference/**/html*/*.html"/>
				<include name="doc/reference/**/pdf/*.pdf"/>
				<include name="doc/**/shared/**"/>
				<include name="examples/**"/>
				<include name="metawidget.jar"/>
			</fileset>
		</copy>
	
		<antcall target="pack-debug"/>
		<copy todir="${build.dir}/${metawidget.name}">
			<fileset dir="${build.dir}">
				<include name="debug/**"/>
			</fileset>
		</copy>

		<zip zipfile="${build.dir}/${metawidget.name}-src.zip">
			<fileset dir="${build.dir}">
				
				<include name="${metawidget.name}/documentation.html"/>
				<include name="${metawidget.name}/lgpl.txt"/>
				<include name="${metawidget.name}/readme.txt"/>

				<!-- Libs. This includes libs for examples, so that they are not scattered -->
				<!-- and duplicated all over the ZIP. However, scattering and duplicating  -->
				<!-- is useful for some IDE deployers, such as MyEclipse                   -->
					
				<include name="${metawidget.name}/lib/**"/>

				<!-- Source -->
					
				<include name="${metawidget.name}/examples/src/**"/>
				<include name="${metawidget.name}/src/**"/>
				<include name="${metawidget.name}/test/**"/>
				<include name="${metawidget.name}/build.xml"/>
				<include name="${metawidget.name}/build.properties"/>
			
			</fileset>				
		</zip>
		
		<!-- Binaries -->
			
		<zip zipfile="${build.dir}/${metawidget.name}.zip">
			<fileset dir="${build.dir}">
				
				<!-- Metawidget -->
					
				<include name="${metawidget.name}/metawidget.jar"/>
				<include name="${metawidget.name}/documentation.html"/>				
				<include name="${metawidget.name}/lgpl.txt"/>
				<include name="${metawidget.name}/readme.txt"/>
				<include name="${metawidget.name}/debug/**"/>

				<!-- Doc -->

				<include name="${metawidget.name}/doc/**"/>
				<exclude name="${metawidget.name}/doc/reference/**/tmp/**"/>
				
				<!-- Examples -->
				
				<include name="${metawidget.name}/examples/**"/>
				<exclude name="${metawidget.name}/examples/android/addressbook/**"/>
				<exclude name="${metawidget.name}/examples/android/addressbook-android.ap_"/>
				<exclude name="${metawidget.name}/examples/src/**"/>
									
			</fileset>				
		</zip>

	</target>

</project>
